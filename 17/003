<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="سهل إيطالي">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="تطبيق سهل إيطالي لتعلم اللغة الإيطالية من المستوى A1 إلى B2 - تعلم الكلمات والعبارات والقواعد والمحادثات بسهولة">
    <meta name="keywords" content="تعلم الإيطالية, اللغة الإيطالية, Italian language, learn Italian, A1, A2, B1, B2, سهل إيطالي, SahlItaly">
    <meta name="author" content="SahlItaly">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.sahlitaly.com/">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.sahlitaly.com/">
    <meta property="og:title" content="سهل إيطالي - تعلم الإيطالية من A1 إلى B2">
    <meta property="og:description" content="تطبيق لتعلم اللغة الإيطالية - كلمات، عبارات، قواعد، محادثات">
    <meta property="og:locale" content="ar_AR">
    
    <title>سهل إيطالي - SahlItaly</title>
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebApplication","name":"سهل إيطالي","description":"تطبيق لتعلم اللغة الإيطالية من A1 إلى B2","url":"https://www.sahlitaly.com","applicationCategory":"EducationalApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},"inLanguage":["ar","it"]}
    </script>
    
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #10B981;
            --secondary: #8B5CF6;
            --accent: #F59E0B;
            --success: #22C55E;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #06B6D4;
            --a1-color: #22C55E;
            --a2-color: #3B82F6;
            --b1-color: #F59E0B;
            --b2-color: #EF4444;
            --dark: #1F2937;
            --light: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 16px;
            --radius-sm: 10px;
            --nav-height: 60px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body.dark-mode {
            --dark: #111827;
            --light: #1F2937;
            --card-bg: #374151;
            --text-main: #F3F4F6;
            --text-secondary: #9CA3AF;
            --border: #4B5563;
            background: linear-gradient(135deg, #111827 0%, #1F2937 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); color: var(--text-main); -webkit-font-smoothing: antialiased; }
        .italian-text { direction: ltr; unicode-bidi: bidi-override; text-align: left; }

        /* Loading */
        .loading-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #059669, #047857); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s, visibility 0.5s; }
        .loading-overlay.hide { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 18px; font-weight: 700; }
        .offline-banner { position: fixed; top: 0; left: 0; right: 0; background: var(--warning); color: white; padding: 8px; text-align: center; font-size: 12px; font-weight: 600; z-index: 99999; display: none; }
        .offline-banner.show { display: block; }

        /* App Layout */
        .app-wrapper { display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
        .app-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 15px; padding-top: calc(12px + env(safe-area-inset-top)); flex-shrink: 0; z-index: 100; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header-logo { display: flex; align-items: center; gap: 10px; }
        .header-logo-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .header-title { font-size: 18px; font-weight: 800; }
        .header-subtitle { font-size: 10px; opacity: 0.9; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { width: 36px; height: 36px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; transition: transform 0.1s; }
        .header-btn:active { transform: scale(0.95); }
        .header-btn .badge { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; font-size: 8px; font-weight: 700; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .stats-bar { display: flex; gap: 8px; }
        .stat-item { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .page { display: none; padding: 15px; padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px); }
        .page.active { display: block; animation: fadeIn 0.15s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--nav-height) + var(--safe-bottom)); background: var(--card-bg); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 8px; padding-bottom: var(--safe-bottom); box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 9999; border-top: 1px solid var(--border); }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 6px 12px; color: var(--text-secondary); font-size: 10px; font-weight: 600; cursor: pointer; border: none; background: none; min-width: 60px; transition: color 0.2s; position: relative; }
        .nav-item i { font-size: 20px; margin-bottom: 3px; transition: transform 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: scale(1.15); }
        .nav-item.active::before { content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 35px; height: 3px; background: var(--primary); border-radius: 0 0 3px 3px; }

        /* Word of Day */
        .word-of-day { background: linear-gradient(135deg, #667eea, #764ba2); border-radius: var(--radius); color: white; box-shadow: var(--shadow-lg); overflow: hidden; margin-bottom: 12px; }
        .word-of-day.collapsed { cursor: pointer; }
        .word-of-day-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; }
        .word-of-day-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .word-of-day-date { font-size: 9px; opacity: 0.8; margin-top: 2px; }
        .word-of-day-actions { display: flex; gap: 6px; }
        .word-of-day-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .word-of-day-btn.liked { background: var(--danger); }
        .word-of-day-content { padding: 0 12px 12px; text-align: center; }
        .word-of-day.collapsed .word-of-day-content { display: none; }
        .word-of-day-italian { font-size: 22px; font-weight: 800; margin-bottom: 3px; direction: ltr; }
        .word-of-day-phonetic { font-size: 11px; opacity: 0.8; margin-bottom: 6px; font-style: italic; direction: ltr; }
        .word-of-day-type { display: inline-block; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 8px; font-size: 9px; margin-bottom: 8px; }
        .word-of-day-arabic { font-size: 16px; font-weight: 600; padding: 8px; background: rgba(255,255,255,0.1); border-radius: var(--radius-sm); margin-bottom: 8px; }
        .word-of-day-example { background: rgba(0,0,0,0.2); padding: 8px 10px; border-radius: var(--radius-sm); }
        .word-of-day-example-label { font-size: 9px; opacity: 0.7; margin-bottom: 3px; }
        .word-of-day-example-it { font-size: 12px; font-weight: 600; margin-bottom: 2px; direction: ltr; }
        .word-of-day-example-ar { font-size: 11px; opacity: 0.9; }
        .word-of-day-collapsed-view { display: none; padding: 0 12px 10px; align-items: center; justify-content: space-between; }
        .word-of-day.collapsed .word-of-day-collapsed-view { display: flex; }
        .word-of-day-collapsed-text { display: flex; align-items: center; gap: 8px; }
        .word-of-day-collapsed-word { font-size: 14px; font-weight: 700; direction: ltr; }
        .word-of-day-collapsed-meaning { font-size: 12px; opacity: 0.9; }
        .word-of-day-expand-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 12px; font-size: 10px; cursor: pointer; font-family: 'Tajawal', sans-serif; }

        /* Daily Goal */
        .daily-goal { background: linear-gradient(135deg, var(--accent), #FB923C); color: white; border-radius: var(--radius); padding: 12px 15px; margin-bottom: 12px; }
        .daily-goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .daily-goal-title { font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .daily-goal-level { font-size: 10px; background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; }
        .daily-goal-xp { font-size: 12px; }
        .daily-goal-progress { height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
        .daily-goal-fill { height: 100%; background: white; border-radius: 3px; transition: width 0.3s ease; }
        .daily-goal-streak { display: flex; justify-content: space-between; margin-top: 8px; font-size: 10px; opacity: 0.9; }

        /* Level Selector */
        .level-selector { background: var(--card-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); margin-bottom: 12px; }
        .level-selector-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .level-tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .level-tab { padding: 12px 8px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--light); text-align: center; cursor: pointer; font-weight: 700; font-size: 14px; position: relative; transition: transform 0.1s, background 0.2s; }
        .level-tab.a1 { border-color: var(--a1-color); color: var(--a1-color); }
        .level-tab.a2 { border-color: var(--a2-color); color: var(--a2-color); }
        .level-tab.b1 { border-color: var(--b1-color); color: var(--b1-color); }
        .level-tab.b2 { border-color: var(--b2-color); color: var(--b2-color); }
        .level-tab.active.a1 { background: var(--a1-color); color: white; }
        .level-tab.active.a2 { background: var(--a2-color); color: white; }
        .level-tab.active.b1 { background: var(--b1-color); color: white; }
        .level-tab.active.b2 { background: var(--b2-color); color: white; }
        .level-tab:active { transform: scale(0.95); }
        .level-tab small { display: block; font-size: 9px; margin-top: 2px; opacity: 0.8; }
        .level-tab .level-progress-indicator { width: 100%; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .level-tab.active .level-progress-indicator { background: rgba(255,255,255,0.3); }
        .level-progress-indicator-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
        .level-tab.active .level-progress-indicator-fill { background: white; }
        .level-tab.a1:not(.active) .level-progress-indicator-fill { background: var(--a1-color); }
        .level-tab.a2:not(.active) .level-progress-indicator-fill { background: var(--a2-color); }
        .level-tab.b1:not(.active) .level-progress-indicator-fill { background: var(--b1-color); }
        .level-tab.b2:not(.active) .level-progress-indicator-fill { background: var(--b2-color); }

        /* Progress Overview */
        .progress-overview { background: var(--card-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-title { font-size: 13px; font-weight: 700; }
        .progress-percentage { font-size: 16px; font-weight: 800; color: var(--primary); }
        .progress-bar-container { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 12px; }
        .progress-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .progress-bar-fill.a1 { background: linear-gradient(to right, var(--a1-color), #4ADE80); }
        .progress-bar-fill.a2 { background: linear-gradient(to right, var(--a2-color), #60A5FA); }
        .progress-bar-fill.b1 { background: linear-gradient(to right, var(--b1-color), #FBBF24); }
        .progress-bar-fill.b2 { background: linear-gradient(to right, var(--b2-color), #F87171); }
        .progress-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .progress-stat { text-align: center; padding: 8px; background: var(--light); border-radius: var(--radius-sm); }
        .progress-stat-value { font-size: 16px; font-weight: 800; color: var(--primary); }
        .progress-stat-label { font-size: 9px; color: var(--text-secondary); }

        /* Section Grid */
        .section-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .section-card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; text-align: center; cursor: pointer; box-shadow: var(--shadow); position: relative; overflow: hidden; transition: transform 0.1s; }
        .section-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .section-card.words::before { background: var(--a1-color); }
        .section-card.phrases::before { background: var(--a2-color); }
        .section-card.conversations::before { background: var(--b1-color); }
        .section-card.grammar::before { background: var(--b2-color); }
        .section-card.quiz::before { background: var(--secondary); }
        .section-card.practice::before { background: var(--accent); }
        .section-card:active { transform: scale(0.97); }
        .section-card-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin: 0 auto 10px; color: white; }
        .section-card.words .section-card-icon { background: linear-gradient(135deg, var(--a1-color), #4ADE80); }
        .section-card.phrases .section-card-icon { background: linear-gradient(135deg, var(--a2-color), #60A5FA); }
        .section-card.conversations .section-card-icon { background: linear-gradient(135deg, var(--b1-color), #FBBF24); }
        .section-card.grammar .section-card-icon { background: linear-gradient(135deg, var(--b2-color), #F87171); }
        .section-card.quiz .section-card-icon { background: linear-gradient(135deg, var(--secondary), #A855F7); }
        .section-card.practice .section-card-icon { background: linear-gradient(135deg, var(--accent), #FB923C); }
        .section-card-title { font-size: 13px; font-weight: 700; margin-bottom: 3px; }
        .section-card-count { font-size: 10px; color: var(--text-secondary); }
        .section-card-badge { position: absolute; top: 8px; left: 8px; background: var(--danger); color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; }

        /* Page Header */
        .page-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .page-back { width: 38px; height: 38px; border-radius: 10px; border: none; background: var(--light); color: var(--text-main); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .page-back:active { transform: scale(0.95); }
        .page-title { font-size: 18px; font-weight: 800; }
        .page-subtitle { font-size: 11px; color: var(--text-secondary); }

        /* Search Box */
        .search-box { background: var(--card-bg); border-radius: var(--radius-sm); padding: 10px 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 12px; box-shadow: var(--shadow); }
        .search-box input { flex: 1; border: none; background: none; font-size: 14px; color: var(--text-main); outline: none; font-family: 'Tajawal', sans-serif; }
        .search-box input::placeholder { color: var(--text-secondary); }

        /* Category List */
        .category-list { display: flex; flex-direction: column; gap: 10px; }
        .category-item { background: var(--card-bg); border-radius: var(--radius-sm); padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; box-shadow: var(--shadow); transition: transform 0.1s; }
        .category-item:active { transform: scale(0.98); }
        .category-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .category-info { flex: 1; }
        .category-name { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
        .category-meta { font-size: 11px; color: var(--text-secondary); }
        .category-progress-value { font-size: 14px; font-weight: 800; color: var(--primary); }
        .category-arrow { color: var(--text-secondary); font-size: 12px; }

        /* Word Card */
        .word-card-container { perspective: 1500px; height: 260px; margin-bottom: 15px; }
        .word-card { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .word-card.flipped { transform: rotateY(180deg); }
        .word-card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: var(--radius); padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: var(--shadow-lg); }
        .word-card-front { background: var(--card-bg); border: 2px solid var(--border); }
        .word-card-back { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; transform: rotateY(180deg); }
        .word-level-badge { position: absolute; top: 12px; left: 12px; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; color: white; }
        .word-level-badge.a1 { background: var(--a1-color); }
        .word-level-badge.a2 { background: var(--a2-color); }
        .word-level-badge.b1 { background: var(--b1-color); }
        .word-level-badge.b2 { background: var(--b2-color); }
        .word-type-badge { position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; background: rgba(0,0,0,0.05); }
        .word-favorite-btn { position: absolute; bottom: 12px; left: 12px; width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(236, 72, 153, 0.1); color: #ec4899; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .word-favorite-btn.liked { background: #ec4899; color: white; }
        .word-favorite-btn:active { transform: scale(0.9); }
        .word-main { font-size: 28px; font-weight: 800; margin-bottom: 8px; text-align: center; direction: ltr; }
        .word-phonetic { font-size: 13px; color: var(--text-secondary); font-style: italic; direction: ltr; }
        .word-translation { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 12px; }
        .word-example { font-size: 13px; text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: var(--radius-sm); width: 100%; }
        .word-example .italian-example { direction: ltr; display: block; }
        .word-card-hint { position: absolute; bottom: 12px; font-size: 11px; opacity: 0.6; }

        /* Word Controls */
        .word-controls { display: flex; gap: 8px; margin-bottom: 12px; }
        .word-control-btn { flex: 1; padding: 10px; border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-family: 'Tajawal', sans-serif; transition: transform 0.1s; }
        .word-control-btn.primary { background: var(--primary); color: white; }
        .word-control-btn.secondary { background: var(--light); color: var(--text-main); border: 2px solid var(--border); }
        .word-control-btn:active { transform: scale(0.95); }
        .word-control-btn:disabled { opacity: 0.5; pointer-events: none; }

        /* Rating Buttons */
        .rating-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
        .rating-btn { padding: 12px 5px; border: 2px solid transparent; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-family: 'Tajawal', sans-serif; transition: transform 0.1s, box-shadow 0.2s; }
        .rating-btn.again { background: rgba(239,68,68,0.1); color: var(--danger); }
        .rating-btn.hard { background: rgba(245,158,11,0.1); color: var(--warning); }
        .rating-btn.good { background: rgba(59,130,246,0.1); color: var(--info); }
        .rating-btn.easy { background: rgba(34,197,94,0.1); color: var(--success); }
        .rating-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .rating-btn:active { transform: scale(0.95); }
        .rating-btn .interval-preview { font-size: 9px; opacity: 0.7; }
        .rating-btn.again:hover { border-color: var(--danger); }
        .rating-btn.hard:hover { border-color: var(--warning); }
        .rating-btn.good:hover { border-color: var(--info); }
        .rating-btn.easy:hover { border-color: var(--success); }
        .srs-info { background: var(--light); border-radius: var(--radius-sm); padding: 10px; font-size: 11px; color: var(--text-secondary); }
        .srs-info-title { font-weight: 700; color: var(--text-main); margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }

        /* Quiz */
        .quiz-container { background: var(--card-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); }
        .quiz-progress { display: flex; align-items: center; margin-bottom: 15px; font-weight: 700; font-size: 13px; }
        .quiz-progress-bar { flex: 1; height: 6px; background: var(--border); border-radius: 3px; margin: 0 10px; overflow: hidden; }
        .quiz-progress-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s; }
        .quiz-question { text-align: center; margin-bottom: 20px; }
        .quiz-question-text { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .quiz-question-text .italian-word { direction: ltr; display: inline; }
        .quiz-question-hint { font-size: 12px; color: var(--text-secondary); }
        .quiz-options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .quiz-option { padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: border-color 0.2s, background 0.2s; }
        .quiz-option.selected { border-color: var(--primary); background: rgba(5,150,105,0.1); }
        .quiz-option.correct { border-color: var(--success); background: rgba(34,197,94,0.1); }
        .quiz-option.wrong { border-color: var(--danger); background: rgba(239,68,68,0.1); }
        .quiz-option.disabled { pointer-events: none; }
        .quiz-option-letter { width: 28px; height: 28px; border-radius: 50%; background: var(--light); display: flex; align-items: center; justify-content: center; font-size: 13px; transition: background 0.2s; }
        .quiz-option.selected .quiz-option-letter { background: var(--primary); color: white; }
        .quiz-option.correct .quiz-option-letter { background: var(--success); color: white; }
        .quiz-option.wrong .quiz-option-letter { background: var(--danger); color: white; }
        .quiz-option-text { flex: 1; }
        .quiz-option-speak { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .quiz-result { text-align: center; padding: 20px; }
        .quiz-result-icon { font-size: 50px; margin-bottom: 15px; }
        .quiz-result-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
        .quiz-result-score { font-size: 16px; color: var(--text-secondary); margin-bottom: 15px; }
        .quiz-result-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .quiz-result-stat { background: var(--light); padding: 12px; border-radius: var(--radius-sm); }
        .quiz-result-stat-value { font-size: 20px; font-weight: 800; }
        .quiz-result-stat-label { font-size: 11px; color: var(--text-secondary); }

        /* Voice */
        .voice-input-btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--secondary), #A855F7); color: white; font-size: 24px; cursor: pointer; margin: 15px auto; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-lg); transition: transform 0.1s; }
        .voice-input-btn.listening { animation: pulse 1s infinite; background: linear-gradient(135deg, var(--danger), #F87171); }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .voice-result { text-align: center; padding: 10px; background: var(--light); border-radius: var(--radius-sm); margin-top: 10px; font-size: 14px; font-weight: 600; }
        .listening-btn { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border: none; color: white; font-size: 30px; cursor: pointer; margin-bottom: 20px; box-shadow: var(--shadow-lg); }

        /* Profile */
        .profile-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 15px; }
        .profile-avatar { width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; }
        .profile-level { font-size: 22px; font-weight: 800; }
        .profile-xp { font-size: 14px; opacity: 0.9; margin-bottom: 12px; }
        .profile-progress { height: 5px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .profile-progress-fill { height: 100%; background: white; border-radius: 3px; transition: width 0.3s; }
        .profile-next { font-size: 10px; opacity: 0.8; }

        /* Favorites */
        .favorites-header { background: linear-gradient(135deg, #ec4899, #f43f5e); color: white; border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 15px; }
        .favorites-icon { font-size: 40px; margin-bottom: 10px; }
        .favorites-count { font-size: 24px; font-weight: 800; }
        .favorites-label { font-size: 12px; opacity: 0.9; }
        .favorites-actions { display: flex; gap: 10px; margin-top: 15px; }
        .favorites-action-btn { flex: 1; padding: 10px; border: none; border-radius: var(--radius-sm); background: rgba(255,255,255,0.2); color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-family: 'Tajawal', sans-serif; }
        .favorites-empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .favorites-empty i { font-size: 50px; margin-bottom: 15px; opacity: 0.3; }
        .liked-word-item { background: var(--card-bg); border-radius: var(--radius-sm); padding: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; box-shadow: var(--shadow); }
        .liked-word-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #ec4899, #f43f5e); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .liked-word-info { flex: 1; }
        .liked-word-it { font-size: 14px; font-weight: 700; direction: ltr; text-align: right; }
        .liked-word-ar { font-size: 12px; color: var(--text-secondary); }
        .liked-word-level { font-size: 9px; padding: 2px 6px; border-radius: 4px; color: white; margin-top: 3px; display: inline-block; }
        .liked-word-level.a1 { background: var(--a1-color); }
        .liked-word-level.a2 { background: var(--a2-color); }
        .liked-word-level.b1 { background: var(--b1-color); }
        .liked-word-level.b2 { background: var(--b2-color); }
        .liked-word-actions { display: flex; gap: 5px; }
        .liked-word-btn { width: 32px; height: 32px; border-radius: 8px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .liked-word-btn.speak { background: var(--light); color: var(--primary); }
        .liked-word-btn.delete { background: rgba(239,68,68,0.1); color: var(--danger); }

        /* My Words Page */
        .my-words-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .my-words-stat { background: var(--card-bg); border-radius: var(--radius); padding: 15px 10px; text-align: center; cursor: pointer; box-shadow: var(--shadow); transition: transform 0.2s; border: 2px solid transparent; }
        .my-words-stat:hover { transform: translateY(-2px); }
        .my-words-stat.active { border-color: var(--primary); }
        .my-words-stat.again { border-top: 3px solid var(--danger); }
        .my-words-stat.hard { border-top: 3px solid var(--warning); }
        .my-words-stat.good { border-top: 3px solid var(--info); }
        .my-words-stat.easy { border-top: 3px solid var(--success); }
        .my-words-stat.again.active { background: rgba(239,68,68,0.1); border-color: var(--danger); }
        .my-words-stat.hard.active { background: rgba(245,158,11,0.1); border-color: var(--warning); }
        .my-words-stat.good.active { background: rgba(59,130,246,0.1); border-color: var(--info); }
        .my-words-stat.easy.active { background: rgba(34,197,94,0.1); border-color: var(--success); }
        .my-words-stat-icon { font-size: 24px; margin-bottom: 5px; }
        .my-words-stat-value { font-size: 22px; font-weight: 800; }
        .my-words-stat.again .my-words-stat-value { color: var(--danger); }
        .my-words-stat.hard .my-words-stat-value { color: var(--warning); }
        .my-words-stat.good .my-words-stat-value { color: var(--info); }
        .my-words-stat.easy .my-words-stat-value { color: var(--success); }
        .my-words-stat-label { font-size: 11px; color: var(--text-secondary); font-weight: 600; }
        .my-words-level-filter { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 5px; }
        .level-filter-btn { padding: 8px 16px; border: 2px solid var(--border); border-radius: 20px; background: var(--card-bg); font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; font-family: 'Tajawal', sans-serif; }
        .level-filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .my-words-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .my-words-action-btn { padding: 12px; border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Tajawal', sans-serif; position: relative; }
        .my-words-action-btn:active { transform: scale(0.98); }
        .my-words-action-btn.review { background: linear-gradient(135deg, var(--danger), #F87171); color: white; }
        .my-words-action-btn.study { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .due-badge { position: absolute; top: -5px; left: -5px; background: var(--accent); color: white; font-size: 10px; font-weight: 700; min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 0 5px; }
        .my-word-card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; margin-bottom: 10px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 12px; border-right: 4px solid transparent; }
        .my-word-card.again { border-right-color: var(--danger); }
        .my-word-card.hard { border-right-color: var(--warning); }
        .my-word-card.good { border-right-color: var(--info); }
        .my-word-card.easy { border-right-color: var(--success); }
        .my-word-rating { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .my-word-card.again .my-word-rating { background: rgba(239,68,68,0.15); }
        .my-word-card.hard .my-word-rating { background: rgba(245,158,11,0.15); }
        .my-word-card.good .my-word-rating { background: rgba(59,130,246,0.15); }
        .my-word-card.easy .my-word-rating { background: rgba(34,197,94,0.15); }
        .my-word-info { flex: 1; min-width: 0; }
        .my-word-italian { font-size: 16px; font-weight: 700; direction: ltr; text-align: right; margin-bottom: 3px; }
        .my-word-arabic { font-size: 13px; color: var(--text-secondary); margin-bottom: 5px; }
        .my-word-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .my-word-level { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; color: white; }
        .my-word-level.a1 { background: var(--a1-color); }
        .my-word-level.a2 { background: var(--a2-color); }
        .my-word-level.b1 { background: var(--b1-color); }
        .my-word-level.b2 { background: var(--b2-color); }
        .my-word-next-review { font-size: 10px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; }
        .my-word-streak { font-size: 10px; color: var(--accent); font-weight: 600; }
        .my-word-actions { display: flex; gap: 5px; }
        .my-word-btn { width: 36px; height: 36px; border-radius: 10px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .my-word-btn:active { transform: scale(0.9); }
        .my-word-btn.speak { background: var(--light); color: var(--primary); }
        .my-word-btn.study { background: var(--primary); color: white; }
        .my-words-empty { text-align: center; padding: 50px 20px; color: var(--text-secondary); }
        .my-words-empty-icon { font-size: 60px; margin-bottom: 15px; opacity: 0.5; }
        .my-words-empty-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--text-main); }
        .my-words-empty-text { font-size: 13px; margin-bottom: 20px; }
        .my-words-section { margin-bottom: 20px; }
        .my-words-section-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
        .my-words-section-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .my-words-section-count { font-size: 12px; color: var(--text-secondary); background: var(--light); padding: 3px 10px; border-radius: 10px; }
        .my-words-progress-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: var(--radius); padding: 15px; color: white; margin-bottom: 15px; }
        .my-words-progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .my-words-progress-title { font-size: 14px; font-weight: 700; }
        .my-words-progress-value { font-size: 18px; font-weight: 800; }
        .my-words-progress-bar { height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .my-words-progress-fill { height: 100%; background: white; border-radius: 4px; transition: width 0.3s; }
        .my-words-progress-stats { display: flex; justify-content: space-between; font-size: 11px; opacity: 0.9; }

        /* Exercise */
        .exercise-card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .exercise-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; text-align: center; }
        .exercise-input { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 16px; font-family: 'Tajawal', sans-serif; text-align: center; outline: none; margin-bottom: 15px; background: var(--card-bg); color: var(--text-main); direction: ltr; transition: border-color 0.2s; }
        .exercise-input:focus { border-color: var(--primary); }
        .exercise-input.correct { border-color: var(--success); background: rgba(34,197,94,0.1); }
        .exercise-input.wrong { border-color: var(--danger); background: rgba(239,68,68,0.1); }
        .exercise-hint { text-align: center; color: var(--text-secondary); font-size: 12px; margin-bottom: 10px; }
        .letter-tiles { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; direction: ltr; }
        .letter-tile { width: 40px; height: 40px; background: var(--light); border: 2px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
        .letter-tile:active { transform: scale(0.95); }
        .letter-tile.selected { background: var(--primary); border-color: var(--primary); color: white; }
        .letter-tile.disabled { opacity: 0.3; pointer-events: none; }
        .answer-tiles { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; min-height: 50px; padding: 10px; background: var(--light); border-radius: var(--radius-sm); direction: ltr; }
        .matching-game { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .matching-card { aspect-ratio: 1; background: var(--light); border: 2px solid var(--border); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; cursor: pointer; padding: 8px; text-align: center; transition: transform 0.2s, background 0.2s; }
        .matching-card.flipped { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }
        .matching-card.matched { background: var(--success); border-color: var(--success); color: white; pointer-events: none; }
        .matching-card.wrong { animation: shake 0.4s ease; background: rgba(239,68,68,0.2); border-color: var(--danger); }
        .matching-card.italian-card { direction: ltr; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }
        .matching-stats { display: flex; justify-content: center; gap: 20px; padding: 10px; background: var(--light); border-radius: var(--radius-sm); margin-bottom: 15px; }
        .matching-stat { text-align: center; }
        .matching-stat-value { font-size: 20px; font-weight: 800; color: var(--primary); }
        .matching-stat-label { font-size: 10px; color: var(--text-secondary); }

        /* Phrase & Conversation */
        .phrase-card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; margin-bottom: 12px; box-shadow: var(--shadow); }
        .phrase-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .phrase-italian { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 5px; direction: ltr; text-align: right; }
        .phrase-arabic { font-size: 16px; margin-bottom: 8px; }
        .phrase-phonetic { font-size: 12px; color: var(--text-secondary); font-style: italic; direction: ltr; text-align: right; }
        .phrase-speak-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 16px; cursor: pointer; }
        .conversation-container { padding: 15px; background: var(--light); border-radius: var(--radius); margin-bottom: 15px; }
        .conversation-bubble { padding: 12px 15px; border-radius: 18px; margin-bottom: 12px; max-width: 85%; position: relative; }
        .conversation-bubble.person-a { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; margin-left: auto; border-bottom-right-radius: 5px; }
        .conversation-bubble.person-b { background: var(--card-bg); border: 1px solid var(--border); border-bottom-left-radius: 5px; box-shadow: var(--shadow); }
        .conversation-bubble.highlighted { transform: scale(1.02); box-shadow: 0 4px 20px rgba(5,150,105,0.3); }
        .conversation-speaker { font-size: 10px; font-weight: 700; margin-bottom: 5px; opacity: 0.8; display: flex; align-items: center; gap: 5px; }
        .conversation-speaker-avatar { width: 20px; height: 20px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .conversation-bubble.person-b .conversation-speaker-avatar { background: var(--primary); color: white; }
        .conversation-text-it { font-size: 15px; font-weight: 600; margin-bottom: 4px; direction: ltr; text-align: left; }
        .conversation-text-ar { font-size: 12px; opacity: 0.85; }
        .conversation-speak-btn { position: absolute; top: 8px; left: 8px; width: 28px; height: 28px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: inherit; font-size: 12px; cursor: pointer; }
        .conversation-bubble.person-b .conversation-speak-btn { background: var(--light); color: var(--primary); }
        .conversation-controls { background: var(--card-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); }
        .conversation-mode-tabs { display: flex; gap: 8px; margin-bottom: 15px; }
        .conversation-mode-tab { flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--light); font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; font-family: 'Tajawal', sans-serif; }
        .conversation-mode-tab.active { border-color: var(--primary); background: rgba(5,150,105,0.1); color: var(--primary); }
        .conversation-mode-tab i { display: block; font-size: 18px; margin-bottom: 5px; }
        .conversation-speed-control { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; background: var(--light); border-radius: var(--radius-sm); margin-bottom: 12px; }
        .conversation-speed-label { font-size: 12px; font-weight: 600; }
        .conversation-speed-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 11px; font-weight: 700; font-family: 'Tajawal', sans-serif; }
        .conversation-speed-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
        .conversation-play-btn { width: 100%; padding: 12px; border: none; border-radius: var(--radius-sm); font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Tajawal', sans-serif; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; margin-bottom: 10px; }
        .conversation-play-btn.playing { background: linear-gradient(135deg, var(--danger), #F87171); }
        .conversation-practice-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .conversation-practice-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .conversation-role-selector { display: flex; gap: 8px; margin-bottom: 12px; }
        .role-btn { flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--light); font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; font-family: 'Tajawal', sans-serif; }
        .role-btn.active { border-color: var(--secondary); background: rgba(139,92,246,0.1); color: var(--secondary); }
        .conversation-record-btn { width: 100%; padding: 15px; border: none; border-radius: var(--radius-sm); background: linear-gradient(135deg, var(--secondary), #A855F7); color: white; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Tajawal', sans-serif; }
        .conversation-record-btn.recording { background: linear-gradient(135deg, var(--danger), #F87171); animation: pulse 1s infinite; }
        .conversation-progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 12px; overflow: hidden; }
        .conversation-progress-fill { height: 100%; background: var(--primary); border-radius: 2px; transition: width 0.3s; }

        /* Grammar */
        .grammar-section { background: var(--card-bg); border-radius: var(--radius); padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .grammar-section-title { font-size: 16px; font-weight: 700; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .grammar-table { width: 100%; border-collapse: collapse; }
        .grammar-table th, .grammar-table td { padding: 10px; text-align: center; border: 1px solid var(--border); }
        .grammar-table th { background: var(--primary); color: white; font-size: 12px; }
        .grammar-table td { font-size: 13px; background: var(--card-bg); }
        .grammar-table td.italian-cell { direction: ltr; }
        .grammar-example { background: var(--light); padding: 12px; border-radius: var(--radius-sm); margin-top: 10px; }
        .grammar-example-it { font-size: 14px; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 10px; direction: ltr; }
        .grammar-example-ar { font-size: 12px; color: var(--text-secondary); margin-top: 5px; }

        /* Achievements */
        .achievements-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .achievement-card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; text-align: center; box-shadow: var(--shadow); position: relative; }
        .achievement-card.locked { opacity: 0.5; }
        .achievement-card.unlocked { border: 2px solid var(--accent); }
        .achievement-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto 10px; background: var(--light); }
        .achievement-card.unlocked .achievement-icon { background: linear-gradient(135deg, var(--accent), #FB923C); }
        .achievement-title { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
        .achievement-desc { font-size: 10px; color: var(--text-secondary); margin-bottom: 8px; }
        .achievement-progress { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .achievement-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; }
        .achievement-badge { position: absolute; top: 8px; right: 8px; font-size: 14px; }
        .achievement-xp { position: absolute; top: 8px; left: 8px; background: var(--accent); color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; }

        /* Statistics */
        .stats-card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .stats-card-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-box { background: var(--light); border-radius: var(--radius-sm); padding: 12px; text-align: center; }
        .stat-box-icon { font-size: 20px; margin-bottom: 5px; }
        .stat-box-value { font-size: 20px; font-weight: 800; color: var(--primary); }
        .stat-box-label { font-size: 10px; color: var(--text-secondary); }
        .weekly-chart { display: flex; justify-content: space-between; align-items: flex-end; height: 100px; padding: 10px 0; gap: 8px; }
        .chart-bar { flex: 1; background: var(--border); border-radius: 4px 4px 0 0; position: relative; min-height: 10px; }
        .chart-bar-fill { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, var(--primary), var(--primary-light)); border-radius: 4px 4px 0 0; transition: height 0.3s; }
        .chart-bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--text-secondary); }
        .level-progress-card { display: flex; gap: 10px; margin-bottom: 10px; }
        .level-progress-item { flex: 1; background: var(--light); border-radius: var(--radius-sm); padding: 10px; text-align: center; }
        .level-progress-label { font-size: 12px; font-weight: 700; margin-bottom: 5px; }
        .level-progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .level-progress-value { font-size: 10px; color: var(--text-secondary); }

        /* Toast */
        .toast { position: fixed; bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--dark); color: white; padding: 10px 20px; border-radius: 25px; z-index: 10000; opacity: 0; transition: all 0.3s; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10001; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); border-radius: var(--radius) var(--radius) 0 0; padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); z-index: 10002; transform: translateY(100%); transition: transform 0.3s; max-height: 85vh; overflow-y: auto; }
        .modal.show { transform: translateY(0); }
        .modal-handle { width: 40px; height: 5px; background: var(--border); border-radius: 3px; margin: 0 auto 15px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 18px; font-weight: 800; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--light); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }

        /* Settings */
        .settings-section { margin-bottom: 24px; }
        .settings-title { font-size: 12px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 12px; border-radius: var(--radius-sm); background: var(--light); margin-bottom: 8px; cursor: pointer; transition: transform 0.1s; }
        .settings-item:active { transform: scale(0.98); }
        .settings-item-info { display: flex; align-items: center; gap: 12px; }
        .settings-item-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--primary); }
        .settings-item-text h4 { font-size: 14px; font-weight: 600; margin-bottom: 3px; }
        .settings-item-text p { font-size: 12px; color: var(--text-secondary); }
        .toggle { width: 48px; height: 26px; background: var(--border); border-radius: 13px; position: relative; cursor: pointer; transition: background 0.2s; }
        .toggle.active { background: var(--primary); }
        .toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: left 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle.active::after { left: 25px; }
        .social-links { display: flex; justify-content: center; gap: 20px; padding: 20px; background: var(--light); border-radius: var(--radius-sm); }
        .social-link { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .social-link.facebook { background: linear-gradient(135deg, #1877F2, #0D65D9); }
        .social-link.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .social-link.tiktok { background: linear-gradient(135deg, #010101, #69C9D0); }

        /* Info Page */
        .info-page-content { background: var(--card-bg); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
        .info-page-icon { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; font-size: 36px; margin: 0 auto 20px; color: white; }
        .info-page-title { font-size: 22px; font-weight: 800; text-align: center; margin-bottom: 20px; }
        .info-page-text { font-size: 14px; line-height: 1.8; text-align: justify; }
        .contact-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--light); border-radius: var(--radius-sm); margin-bottom: 10px; }
        .contact-item-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .contact-item-text { flex: 1; }
        .contact-item-label { font-size: 11px; color: var(--text-secondary); }
        .contact-item-value { font-size: 14px; font-weight: 600; }

        /* Confirm Dialog */
        .confirm-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: var(--card-bg); border-radius: var(--radius); padding: 20px; z-index: 10003; width: 85%; max-width: 320px; opacity: 0; visibility: hidden; transition: all 0.3s; text-align: center; }
        .confirm-dialog.show { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
        .confirm-dialog-icon { font-size: 40px; margin-bottom: 12px; }
        .confirm-dialog-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
        .confirm-dialog-text { font-size: 13px; color: var(--text-secondary); margin-bottom: 15px; }
        .confirm-dialog-buttons { display: flex; gap: 10px; }
        .confirm-dialog-btn { flex: 1; padding: 10px; border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Tajawal', sans-serif; }
        .confirm-dialog-btn.cancel { background: var(--light); color: var(--text-main); }
        .confirm-dialog-btn.confirm { background: var(--danger); color: white; }

        /* Notifications */
        .notifications-dropdown { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10001; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .notifications-dropdown.show { opacity: 1; visibility: visible; }
        .notifications-panel { position: absolute; top: calc(60px + env(safe-area-inset-top)); right: 15px; left: 15px; max-height: 70vh; background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow-lg); overflow: hidden; transform: translateY(-20px); opacity: 0; transition: all 0.3s; }
        .notifications-dropdown.show .notifications-panel { transform: translateY(0); opacity: 1; }
        .notifications-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); background: var(--light); }
        .notifications-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .notifications-clear { background: none; border: none; color: var(--danger); font-size: 12px; font-weight: 600; cursor: pointer; padding: 5px 10px; border-radius: 8px; font-family: 'Tajawal', sans-serif; }
        .notifications-list { max-height: calc(70vh - 60px); overflow-y: auto; }
        .notification-item { display: flex; gap: 12px; padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; position: relative; }
        .notification-item:hover { background: var(--light); }
        .notification-item.unread { background: rgba(5,150,105,0.05); }
        .notification-item.unread::before { content: ''; position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 40px; background: var(--primary); border-radius: 0 4px 4px 0; }
        .notification-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .notification-icon.achievement { background: linear-gradient(135deg, #F59E0B, #FB923C); }
        .notification-icon.streak { background: linear-gradient(135deg, #EF4444, #F87171); }
        .notification-icon.xp { background: linear-gradient(135deg, #8B5CF6, #A855F7); }
        .notification-icon.reminder { background: linear-gradient(135deg, #06B6D4, #22D3EE); }
        .notification-icon.level { background: linear-gradient(135deg, #22C55E, #4ADE80); }
        .notification-content { flex: 1; min-width: 0; }
        .notification-text { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
        .notification-desc { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .notification-time { font-size: 10px; color: var(--text-secondary); }
        .notification-empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .notification-empty i { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }
        .empty-state { text-align: center; padding: 30px; color: var(--text-secondary); }
        .empty-state i { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">جاري تحميل البيانات...</div>
    </div>

    <div class="offline-banner" id="offlineBanner">📴 أنت غير متصل بالإنترنت</div>

    <div class="notifications-dropdown" id="notificationsDropdown" onclick="closeNotifications(event)">
        <div class="notifications-panel" onclick="event.stopPropagation()">
            <div class="notifications-header">
                <div class="notifications-title"><i class="fas fa-bell"></i> الإشعارات</div>
                <button class="notifications-clear" onclick="clearAllNotifications()">مسح الكل</button>
            </div>
            <div class="notifications-list" id="notificationsList"></div>
        </div>
    </div>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage"></span></div>
    <div class="modal-overlay" id="modalOverlay"></div>

    <div class="modal" id="settingsModal">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title">⚙️ الإعدادات</div>
            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="settings-section">
            <div class="settings-title">العرض</div>
            <div class="settings-item" onclick="toggleDarkMode()">
                <div class="settings-item-info"><div class="settings-item-icon"><i class="fas fa-moon"></i></div><div class="settings-item-text"><h4>الوضع الليلي</h4><p>تغيير مظهر التطبيق</p></div></div>
                <div class="toggle" id="darkModeToggle"></div>
            </div>
            <div class="settings-item" onclick="toggleSound()">
                <div class="settings-item-info"><div class="settings-item-icon"><i class="fas fa-volume-up"></i></div><div class="settings-item-text"><h4>الأصوات</h4><p>تفعيل أصوات النطق</p></div></div>
                <div class="toggle active" id="soundToggle"></div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-title">معلومات</div>
            <div class="settings-item" onclick="openInfoPage('about')">
                <div class="settings-item-info">
                    <div class="settings-item-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="settings-item-text"><h4>من نحن</h4><p>تعرف علينا</p></div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--text-secondary);"></i>
            </div>
            <div class="settings-item" onclick="openInfoPage('contact')">
                <div class="settings-item-info">
                    <div class="settings-item-icon"><i class="fas fa-envelope"></i></div>
                    <div class="settings-item-text"><h4>اتصل بنا</h4><p>تواصل معنا</p></div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--text-secondary);"></i>
            </div>
            <div class="settings-item" onclick="openInfoPage('privacy')">
                <div class="settings-item-info">
                    <div class="settings-item-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="settings-item-text"><h4>سياسة الخصوصية</h4><p>كيف نحمي بياناتك</p></div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--text-secondary);"></i>
            </div>
            <div class="settings-item" onclick="openInfoPage('terms')">
                <div class="settings-item-info">
                    <div class="settings-item-icon"><i class="fas fa-file-contract"></i></div>
                    <div class="settings-item-text"><h4>شروط الخدمة</h4><p>شروط الاستخدام</p></div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--text-secondary);"></i>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-title">البيانات</div>
            <div class="settings-item" onclick="resetProgress()"><div class="settings-item-info"><div class="settings-item-icon" style="color: var(--danger);"><i class="fas fa-redo"></i></div><div class="settings-item-text"><h4>إعادة التقدم</h4><p>البدء من جديد</p></div></div><i class="fas fa-chevron-left" style="color: var(--text-secondary);"></i></div>
        </div>
        <div class="settings-section">
            <div class="settings-title">تابعنا</div>
            <div class="social-links" id="socialLinks"></div>
        </div>
    </div>

    <div class="modal" id="achievementModal">
        <div class="modal-handle"></div>
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 60px; margin-bottom: 15px;" id="achievementUnlockedIcon">🏆</div>
            <div style="font-size: 18px; font-weight: 800; margin-bottom: 8px;">إنجاز جديد!</div>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;" id="achievementUnlockedTitle"></div>
            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;" id="achievementUnlockedDesc"></div>
            <div style="display: inline-block; background: var(--accent); color: white; padding: 8px 20px; border-radius: 20px; font-weight: 700;" id="achievementUnlockedXP">+50 XP</div>
            <button class="word-control-btn primary" onclick="closeAchievementModal()" style="margin-top: 20px; width: 100%;">رائع!</button>
        </div>
    </div>

    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-dialog-icon" id="confirmIcon">🗑️</div>
        <div class="confirm-dialog-title" id="confirmTitle">حذف الكلمة؟</div>
        <div class="confirm-dialog-text" id="confirmText">هل تريد حذف هذه الكلمة من المفضلة؟</div>
        <div class="confirm-dialog-buttons">
            <button class="confirm-dialog-btn cancel" onclick="closeConfirmDialog()">إلغاء</button>
            <button class="confirm-dialog-btn confirm" id="confirmBtn" onclick="confirmAction()">حذف</button>
        </div>
    </div>

    <div class="app-wrapper">
        <header class="app-header">
            <div class="header-top">
                <div class="header-logo">
                    <div class="header-logo-icon">🇮🇹</div>
                    <div><div class="header-title" id="appTitle">سهل إيطالي</div><div class="header-subtitle">SahlItaly A1 - B2</div></div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openSection('achievements')"><i class="fas fa-trophy"></i><span class="badge" id="achievementsBadge" style="display: none;">!</span></button>
                    <button class="header-btn" onclick="toggleNotificationsPanel()"><i class="fas fa-bell"></i><span class="badge" id="notificationsBadge" style="display: none;">0</span></button>
                    <button class="header-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat-item"><i class="fas fa-fire"></i><span id="streakCount">0</span></div>
                <div class="stat-item"><i class="fas fa-star"></i><span id="xpCount">0</span> XP</div>
                <div class="stat-item"><i class="fas fa-trophy"></i>مستوى <span id="userLevel">1</span></div>
            </div>
        </header>

        <main class="main-content" id="mainContent">
            <!-- Home Page -->
            <div class="page active" id="homePage">
                <div class="word-of-day" id="wordOfDay">
                    <div class="word-of-day-header">
                        <div><div class="word-of-day-badge">📖 كلمة اليوم</div><div class="word-of-day-date" id="wodDate"></div></div>
                        <div class="word-of-day-actions">
                            <button class="word-of-day-btn" id="wodLikeBtn" onclick="toggleLikeWordOfDay(event)"><i class="far fa-heart"></i></button>
                            <button class="word-of-day-btn" onclick="speakWordOfDay(event)"><i class="fas fa-volume-up"></i></button>
                            <button class="word-of-day-btn" onclick="toggleWordOfDay(event)"><i class="fas fa-chevron-up" id="wodToggleIcon"></i></button>
                        </div>
                    </div>
                    <div class="word-of-day-content" id="wodContent">
                        <div class="word-of-day-italian" id="wodItalian">Ciao</div>
                        <div class="word-of-day-phonetic" id="wodPhonetic">/ˈtʃaːo/</div>
                        <div class="word-of-day-type" id="wodType">تحية</div>
                        <div class="word-of-day-arabic" id="wodArabic">مرحباً</div>
                        <div class="word-of-day-example">
                            <div class="word-of-day-example-label">مثال:</div>
                            <div class="word-of-day-example-it" id="wodExampleIt">Ciao, come stai?</div>
                            <div class="word-of-day-example-ar" id="wodExampleAr">مرحباً، كيف حالك؟</div>
                        </div>
                    </div>
                    <div class="word-of-day-collapsed-view">
                        <div class="word-of-day-collapsed-text"><span class="word-of-day-collapsed-word" id="wodCollapsedWord">Ciao</span><span>-</span><span class="word-of-day-collapsed-meaning" id="wodCollapsedMeaning">مرحباً</span></div>
                        <button class="word-of-day-expand-btn" onclick="toggleWordOfDay(event)"><i class="fas fa-chevron-down"></i> عرض</button>
                    </div>
                </div>

                <div class="daily-goal">
                    <div class="daily-goal-header">
                        <div class="daily-goal-title">🎯 هدفك اليومي <span class="daily-goal-level" id="goalLevelBadge">المستوى 1</span></div>
                        <div class="daily-goal-xp"><span id="dailyXP">0</span> / <span id="dailyTarget">50</span> XP</div>
                    </div>
                    <div class="daily-goal-progress"><div class="daily-goal-fill" id="dailyGoalFill" style="width: 0%"></div></div>
                    <div class="daily-goal-streak">
                        <span>🔥 سلسلة: <span id="goalStreak">0</span> يوم</span>
                        <span id="goalCompletedDays">أيام مكتملة: 0</span>
                    </div>
                </div>

                <div class="level-selector">
                    <div class="level-selector-title"><i class="fas fa-layer-group"></i> اختر المستوى</div>
                    <div class="level-tabs">
                        <div class="level-tab a1 active" onclick="selectLevel('a1')" data-level="a1">A1<small>مبتدئ</small><div class="level-progress-indicator"><div class="level-progress-indicator-fill" id="levelProgressA1" style="width: 0%"></div></div></div>
                        <div class="level-tab a2" onclick="selectLevel('a2')" data-level="a2">A2<small>أساسي</small><div class="level-progress-indicator"><div class="level-progress-indicator-fill" id="levelProgressA2" style="width: 0%"></div></div></div>
                        <div class="level-tab b1" onclick="selectLevel('b1')" data-level="b1">B1<small>متوسط</small><div class="level-progress-indicator"><div class="level-progress-indicator-fill" id="levelProgressB1" style="width: 0%"></div></div></div>
                        <div class="level-tab b2" onclick="selectLevel('b2')" data-level="b2">B2<small>متقدم</small><div class="level-progress-indicator"><div class="level-progress-indicator-fill" id="levelProgressB2" style="width: 0%"></div></div></div>
                    </div>
                </div>

                <div class="progress-overview">
                    <div class="progress-header"><div class="progress-title">تقدمك - <span id="currentLevelDisplay">A1</span></div><div class="progress-percentage" id="levelProgress">0%</div></div>
                    <div class="progress-bar-container"><div class="progress-bar-fill a1" id="levelProgressBar" style="width: 0%"></div></div>
                    <div class="progress-stats">
                        <div class="progress-stat"><div class="progress-stat-value" id="wordsLearned">0</div><div class="progress-stat-label">كلمات</div></div>
                        <div class="progress-stat"><div class="progress-stat-value" id="phrasesLearned">0</div><div class="progress-stat-label">عبارات</div></div>
                        <div class="progress-stat"><div class="progress-stat-value" id="grammarLearned">0</div><div class="progress-stat-label">قواعد</div></div>
                        <div class="progress-stat"><div class="progress-stat-value" id="quizzesDone">0</div><div class="progress-stat-label">اختبارات</div></div>
                    </div>
                </div>

                <div class="section-grid">
                    <div class="section-card words" onclick="openSection('words')"><div class="section-card-icon"><i class="fas fa-font"></i></div><div class="section-card-title">الكلمات</div><div class="section-card-count" id="wordsCount">0 كلمة</div></div>
                    <div class="section-card phrases" onclick="openSection('phrases')"><div class="section-card-icon"><i class="fas fa-comment-dots"></i></div><div class="section-card-title">العبارات</div><div class="section-card-count" id="phrasesCount">0 عبارة</div></div>
                    <div class="section-card conversations" onclick="openSection('conversations')"><div class="section-card-icon"><i class="fas fa-comments"></i></div><div class="section-card-title">المحادثات</div><div class="section-card-count" id="conversationsCount">0 محادثة</div></div>
                    <div class="section-card grammar" onclick="openSection('grammar')"><div class="section-card-icon"><i class="fas fa-book"></i></div><div class="section-card-title">القواعد</div><div class="section-card-count" id="grammarCount">0 درس</div></div>
                    <div class="section-card quiz" onclick="openSection('quiz')"><div class="section-card-badge">جديد</div><div class="section-card-icon"><i class="fas fa-question-circle"></i></div><div class="section-card-title">اختبارات</div><div class="section-card-count">اختبر نفسك</div></div>
                    <div class="section-card practice" onclick="openSection('practice')"><div class="section-card-icon"><i class="fas fa-dumbbell"></i></div><div class="section-card-title">تمارين</div><div class="section-card-count">تدرب يومياً</div></div>
                </div>
            </div>

            <!-- My Words Page -->
            <div class="page" id="myWordsPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">📚 كلماتي</div><div class="page-subtitle">كلماتك حسب مستوى الصعوبة</div></div>
                </div>
                <div class="my-words-stats">
                    <div class="my-words-stat again" onclick="filterMyWords('again')"><div class="my-words-stat-icon">🔄</div><div class="my-words-stat-value" id="myWordsAgainCount">0</div><div class="my-words-stat-label">أعد</div></div>
                    <div class="my-words-stat hard" onclick="filterMyWords('hard')"><div class="my-words-stat-icon">💪</div><div class="my-words-stat-value" id="myWordsHardCount">0</div><div class="my-words-stat-label">صعب</div></div>
                    <div class="my-words-stat good" onclick="filterMyWords('good')"><div class="my-words-stat-icon">👍</div><div class="my-words-stat-value" id="myWordsGoodCount">0</div><div class="my-words-stat-label">جيد</div></div>
                    <div class="my-words-stat easy" onclick="filterMyWords('easy')"><div class="my-words-stat-icon">⭐</div><div class="my-words-stat-value" id="myWordsEasyCount">0</div><div class="my-words-stat-label">سهل</div></div>
                </div>
                <div class="my-words-level-filter">
                    <button class="level-filter-btn active" data-level="all" onclick="filterMyWordsByLevel('all')">الكل</button>
                    <button class="level-filter-btn" data-level="a1" onclick="filterMyWordsByLevel('a1')">A1</button>
                    <button class="level-filter-btn" data-level="a2" onclick="filterMyWordsByLevel('a2')">A2</button>
                    <button class="level-filter-btn" data-level="b1" onclick="filterMyWordsByLevel('b1')">B1</button>
                    <button class="level-filter-btn" data-level="b2" onclick="filterMyWordsByLevel('b2')">B2</button>
                </div>
                <div class="my-words-actions">
                    <button class="my-words-action-btn review" onclick="startReviewSession()"><i class="fas fa-redo"></i> مراجعة الصعبة</button>
                    <button class="my-words-action-btn study" onclick="studyDueWords()"><i class="fas fa-play"></i> المستحقة <span class="due-badge" id="dueWordsBadge">0</span></button>
                </div>
                <div class="search-box"><i class="fas fa-search"></i><input type="text" placeholder="ابحث في كلماتك..." id="myWordsSearch" oninput="searchMyWords()"></div>
                <div id="myWordsContent"></div>
            </div>

            <!-- Words Page -->
            <div class="page" id="wordsPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">الكلمات</div><div class="page-subtitle">المستوى <span class="current-level-text">A1</span></div></div>
                </div>
                <div class="search-box"><i class="fas fa-search"></i><input type="text" placeholder="ابحث عن كلمة..." id="wordSearch" oninput="searchWords()"></div>
                <div class="category-list" id="wordsCategoryList"></div>
            </div>

            <!-- Word Study Page -->
            <div class="page" id="wordStudyPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackFromStudy()"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title" id="wordCategoryTitle">الكلمات</div><div class="page-subtitle"><span id="wordProgress">0/0</span></div></div>
                </div>
                <div class="word-card-container">
                    <div class="word-card" id="wordCard" onclick="flipCard()">
                        <div class="word-card-face word-card-front">
                            <div class="word-level-badge a1" id="wordLevelBadge">A1</div>
                            <div class="word-type-badge" id="wordTypeBadge">اسم</div>
                            <button class="word-favorite-btn" id="wordFavoriteBtn" onclick="event.stopPropagation(); toggleCurrentWordFavorite()"><i class="far fa-heart"></i></button>
                            <div class="word-main" id="wordItalian">Ciao</div>
                            <div class="word-phonetic" id="wordPhonetic">/ˈtʃaːo/</div>
                            <div class="word-card-hint">انقر لرؤية الترجمة</div>
                        </div>
                        <div class="word-card-face word-card-back">
                            <div class="word-translation" id="wordArabic">مرحباً</div>
                            <div class="word-example" id="wordExample"></div>
                            <div class="word-card-hint">انقر للعودة</div>
                        </div>
                    </div>
                </div>
                <div class="word-controls">
                    <button class="word-control-btn secondary" onclick="speakCurrentWord()"><i class="fas fa-volume-up"></i></button>
                    <button class="word-control-btn secondary" onclick="handlePrevWord()"><i class="fas fa-chevron-right"></i></button>
                    <button class="word-control-btn secondary" onclick="handleNextWord()"><i class="fas fa-chevron-left"></i></button>
                    <button class="word-control-btn primary" onclick="shuffleWords()"><i class="fas fa-random"></i></button>
                </div>
                <div class="rating-buttons">
                    <button class="rating-btn again" onclick="rateWord('again')"><i class="fas fa-redo"></i>أعد<span class="interval-preview">< 10 د</span></button>
                    <button class="rating-btn hard" onclick="rateWord('hard')"><i class="fas fa-brain"></i>صعب<span class="interval-preview">1 يوم</span></button>
                    <button class="rating-btn good" onclick="rateWord('good')"><i class="fas fa-thumbs-up"></i>جيد<span class="interval-preview">3 أيام</span></button>
                    <button class="rating-btn easy" onclick="rateWord('easy')"><i class="fas fa-check-double"></i>سهل<span class="interval-preview">7 أيام</span></button>
                </div>
                <div class="srs-info"><div class="srs-info-title"><i class="fas fa-info-circle"></i> نظام التكرار المتباعد</div><p>اختر مستوى صعوبة الكلمة لتحديد متى ستراها مجدداً</p></div>
            </div>

            <!-- Favorites Page -->
            <div class="page" id="favoritesPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('profile')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">❤️ المفضلة</div><div class="page-subtitle">كلماتك المحفوظة</div></div>
                </div>
                <div class="favorites-header">
                    <div class="favorites-icon">❤️</div>
                    <div class="favorites-count" id="favoritesCount">0</div>
                    <div class="favorites-label">كلمة في المفضلة</div>
                    <div class="favorites-actions">
                        <button class="favorites-action-btn" onclick="studyFavorites()"><i class="fas fa-play"></i> دراسة</button>
                        <button class="favorites-action-btn" onclick="quizFavorites()"><i class="fas fa-question"></i> اختبار</button>
                    </div>
                </div>
                <div id="favoritesList"></div>
            </div>

            <!-- Phrases Page -->
            <div class="page" id="phrasesPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">العبارات</div><div class="page-subtitle">المستوى <span class="current-level-text">A1</span></div></div>
                </div>
                <div class="category-list" id="phrasesList"></div>
            </div>

            <!-- Phrase Detail Page -->
            <div class="page" id="phraseDetailPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('phrases')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title" id="phraseDetailTitle">العبارات</div><div class="page-subtitle">تعلم العبارات الشائعة</div></div>
                </div>
                <div id="phraseDetailContent"></div>
            </div>

            <!-- Conversations Page -->
            <div class="page" id="conversationsPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">المحادثات</div><div class="page-subtitle">المستوى <span class="current-level-text">A1</span></div></div>
                </div>
                <div class="category-list" id="conversationsList"></div>
            </div>

            <!-- Conversation Detail Page -->
            <div class="page" id="conversationDetailPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('conversations')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title" id="conversationDetailTitle">المحادثة</div><div class="page-subtitle">تدرب على المحادثة</div></div>
                </div>
                <div id="conversationDetailContent"></div>
            </div>

            <!-- Grammar Page -->
            <div class="page" id="grammarPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">القواعد</div><div class="page-subtitle">المستوى <span class="current-level-text">A1</span></div></div>
                </div>
                <div class="category-list" id="grammarList"></div>
            </div>

            <!-- Grammar Detail Page -->
            <div class="page" id="grammarDetailPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('grammar')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title" id="grammarDetailTitle">القواعد</div><div class="page-subtitle">شرح القاعدة</div></div>
                </div>
                <div id="grammarDetailContent"></div>
            </div>

            <!-- Info Page -->
            <div class="page" id="infoPage">
                <div class="page-header">
                    <button class="page-back" onclick="closeInfoPage()"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title" id="infoPageTitle">معلومات</div></div>
                </div>
                <div class="info-page-content" id="infoPageContent"></div>
            </div>

            <!-- Achievements Page -->
            <div class="page" id="achievementsPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">🏆 الإنجازات</div><div class="page-subtitle"><span id="unlockedAchievements">0</span>/12 مفتوحة</div></div>
                </div>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>

            <!-- Statistics Page -->
            <div class="page" id="statisticsPage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">📊 الإحصائيات</div><div class="page-subtitle">تتبع تقدمك</div></div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-title"><i class="fas fa-chart-pie"></i> نظرة عامة</div>
                    <div class="stats-grid">
                        <div class="stat-box"><div class="stat-box-icon">📚</div><div class="stat-box-value" id="statTotalWords">0</div><div class="stat-box-label">كلمة</div></div>
                        <div class="stat-box"><div class="stat-box-icon">⭐</div><div class="stat-box-value" id="statTotalXP">0</div><div class="stat-box-label">XP</div></div>
                        <div class="stat-box"><div class="stat-box-icon">📝</div><div class="stat-box-value" id="statTotalQuizzes">0</div><div class="stat-box-label">اختبار</div></div>
                        <div class="stat-box"><div class="stat-box-icon">🎯</div><div class="stat-box-value" id="statAccuracy">0%</div><div class="stat-box-label">دقة</div></div>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-title"><i class="fas fa-calendar-week"></i> نشاط الأسبوع</div>
                    <div class="weekly-chart" id="weeklyChart"></div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-title"><i class="fas fa-fire"></i> سلسلة التعلم</div>
                    <div class="stats-grid">
                        <div class="stat-box"><div class="stat-box-icon">🔥</div><div class="stat-box-value" id="statCurrentStreak">0</div><div class="stat-box-label">الحالية</div></div>
                        <div class="stat-box"><div class="stat-box-icon">🏆</div><div class="stat-box-value" id="statLongestStreak">0</div><div class="stat-box-label">الأطول</div></div>
                        <div class="stat-box"><div class="stat-box-icon">📅</div><div class="stat-box-value" id="statTotalDays">0</div><div class="stat-box-label">أيام</div></div>
                        <div class="stat-box"><div class="stat-box-icon">⏱️</div><div class="stat-box-value" id="statAvgTime">0 د</div><div class="stat-box-label">متوسط</div></div>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-title"><i class="fas fa-layer-group"></i> تقدم المستويات</div>
                    <div class="level-progress-card">
                        <div class="level-progress-item"><div class="level-progress-label" style="color: var(--a1-color);">A1</div><div class="level-progress-bar"><div class="progress-bar-fill a1" id="statA1Progress" style="width: 0%"></div></div><div class="level-progress-value" id="statA1Value">0%</div></div>
                        <div class="level-progress-item"><div class="level-progress-label" style="color: var(--a2-color);">A2</div><div class="level-progress-bar"><div class="progress-bar-fill a2" id="statA2Progress" style="width: 0%"></div></div><div class="level-progress-value" id="statA2Value">0%</div></div>
                    </div>
                    <div class="level-progress-card">
                        <div class="level-progress-item"><div class="level-progress-label" style="color: var(--b1-color);">B1</div><div class="level-progress-bar"><div class="progress-bar-fill b1" id="statB1Progress" style="width: 0%"></div></div><div class="level-progress-value" id="statB1Value">0%</div></div>
                        <div class="level-progress-item"><div class="level-progress-label" style="color: var(--b2-color);">B2</div><div class="level-progress-bar"><div class="progress-bar-fill b2" id="statB2Progress" style="width: 0%"></div></div><div class="level-progress-value" id="statB2Value">0%</div></div>
                    </div>
                </div>
            </div>

            <!-- Quiz Type Page -->
            <div class="page" id="quizTypePage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">اختر نوع الاختبار</div><div class="page-subtitle">المستوى <span class="current-level-text">A1</span></div></div>
                </div>
                <div class="category-list">
                    <div class="category-item" onclick="startQuiz('words')"><div class="category-icon" style="background: linear-gradient(135deg, var(--a1-color), #4ADE80); color: white;"><i class="fas fa-font"></i></div><div class="category-info"><div class="category-name">اختبار الكلمات</div><div class="category-meta">10 أسئلة</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                    <div class="category-item" onclick="startQuiz('reverse')"><div class="category-icon" style="background: linear-gradient(135deg, var(--a2-color), #60A5FA); color: white;"><i class="fas fa-exchange-alt"></i></div><div class="category-info"><div class="category-name">عربي ← إيطالي</div><div class="category-meta">10 أسئلة</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                    <div class="category-item" onclick="startQuiz('listening')"><div class="category-icon" style="background: linear-gradient(135deg, var(--b1-color), #FBBF24); color: white;"><i class="fas fa-headphones"></i></div><div class="category-info"><div class="category-name">اختبار الاستماع</div><div class="category-meta">10 أسئلة</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                    <div class="category-item" onclick="startQuiz('mixed')"><div class="category-icon" style="background: linear-gradient(135deg, var(--accent), #FB923C); color: white;"><i class="fas fa-random"></i></div><div class="category-info"><div class="category-name">اختبار شامل</div><div class="category-meta">15 سؤال</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                </div>
            </div>

            <!-- Quiz Page -->
            <div class="page" id="quizPage">
                <div class="page-header">
                    <button class="page-back" onclick="confirmExitQuiz()"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">اختبار</div></div>
                </div>
                <div class="quiz-container" id="quizContainer">
                    <div class="quiz-progress"><span id="quizCurrentQ">1</span><div class="quiz-progress-bar"><div class="quiz-progress-fill" id="quizProgressBar" style="width: 10%"></div></div><span id="quizTotalQ">10</span></div>
                    <div class="quiz-question"><div class="quiz-question-text" id="quizQuestionText">ما معنى "Ciao"؟</div><div class="quiz-question-hint" id="quizQuestionHint">اختر الإجابة الصحيحة</div></div>
                    <div id="quizListeningBtn" style="display: none; text-align: center; margin-bottom: 20px;"><button class="listening-btn" onclick="playQuizAudio()"><i class="fas fa-volume-up"></i></button></div>
                    <div class="quiz-options" id="quizOptions"></div>
                    <button class="word-control-btn primary" id="quizNextBtn" onclick="nextQuizQuestion()" style="display: none; width: 100%;">التالي <i class="fas fa-chevron-left"></i></button>
                </div>
                <div class="quiz-container" id="quizResult" style="display: none;">
                    <div class="quiz-result">
                        <div class="quiz-result-icon" id="quizResultIcon">🎉</div>
                        <div class="quiz-result-title" id="quizResultTitle">ممتاز!</div>
                        <div class="quiz-result-score" id="quizResultScore">8/10</div>
                        <div class="quiz-result-stats">
                            <div class="quiz-result-stat"><div class="quiz-result-stat-value" id="quizCorrectCount" style="color: var(--success);">8</div><div class="quiz-result-stat-label">صحيح</div></div>
                            <div class="quiz-result-stat"><div class="quiz-result-stat-value" id="quizWrongCount" style="color: var(--danger);">2</div><div class="quiz-result-stat-label">خطأ</div></div>
                            <div class="quiz-result-stat"><div class="quiz-result-stat-value" id="quizXPEarned" style="color: var(--accent);">+40</div><div class="quiz-result-stat-label">XP</div></div>
                        </div>
                        <div class="word-controls" style="flex-direction: column; gap: 8px;">
                            <button class="word-control-btn primary" onclick="restartQuiz()" style="width: 100%;"><i class="fas fa-redo"></i> إعادة</button>
                            <button class="word-control-btn secondary" onclick="goBackWithScroll('home')" style="width: 100%;"><i class="fas fa-home"></i> الرئيسية</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Practice Page -->
            <div class="page" id="practicePage">
                <div class="page-header">
                    <button class="page-back" onclick="goBackWithScroll('home')"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title">التمارين</div><div class="page-subtitle">المستوى <span class="current-level-text">A1</span></div></div>
                </div>
                <div class="category-list">
                    <div class="category-item" onclick="startFlashcards()"><div class="category-icon" style="background: linear-gradient(135deg, var(--a1-color), #4ADE80); color: white;"><i class="fas fa-clone"></i></div><div class="category-info"><div class="category-name">بطاقات تعليمية</div><div class="category-meta">راجع الكلمات</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                    <div class="category-item" onclick="startSpellingExercise()"><div class="category-icon" style="background: linear-gradient(135deg, var(--a2-color), #60A5FA); color: white;"><i class="fas fa-spell-check"></i></div><div class="category-info"><div class="category-name">تمرين الإملاء</div><div class="category-meta">اكتب الكلمة</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                    <div class="category-item" onclick="startWordBuilder()"><div class="category-icon" style="background: linear-gradient(135deg, var(--b1-color), #FBBF24); color: white;"><i class="fas fa-puzzle-piece"></i></div><div class="category-info"><div class="category-name">تركيب الكلمات</div><div class="category-meta">رتب الحروف</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                    <div class="category-item" onclick="startMatchingGame()"><div class="category-icon" style="background: linear-gradient(135deg, var(--b2-color), #F87171); color: white;"><i class="fas fa-th"></i></div><div class="category-info"><div class="category-name">لعبة المطابقة</div><div class="category-meta">طابق الكلمات</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                    <div class="category-item" onclick="startListeningExercise()"><div class="category-icon" style="background: linear-gradient(135deg, var(--secondary), #A855F7); color: white;"><i class="fas fa-headphones"></i></div><div class="category-info"><div class="category-name">تمرين الاستماع</div><div class="category-meta">استمع واكتب</div></div><i class="fas fa-chevron-left category-arrow"></i></div>
                </div>
            </div>

            <!-- Exercise Page -->
            <div class="page" id="exercisePage">
                <div class="page-header">
                    <button class="page-back" onclick="exitExercise()"><i class="fas fa-arrow-right"></i></button>
                    <div><div class="page-title" id="exerciseTitle">تمرين</div><div class="page-subtitle"><span id="exerciseProgress">0/10</span></div></div>
                </div>
                <div id="exerciseContent"></div>
            </div>

            <!-- Profile Page -->
            <div class="page" id="profilePage">
                <div class="profile-header">
                    <div class="profile-avatar">👨‍🎓</div>
                    <div class="profile-level">المستوى <span id="profileLevel">1</span></div>
                    <div class="profile-xp"><span id="profileXP">0</span> XP</div>
                    <div class="profile-progress"><div class="profile-progress-fill" id="profileProgressFill" style="width: 0%"></div></div>
                    <div class="profile-next"><span id="profileXPNext">100</span> XP للمستوى التالي</div>
                </div>
                <div class="progress-overview">
                    <div class="progress-title" style="margin-bottom: 12px;">📊 الإحصائيات</div>
                    <div class="progress-stats">
                        <div class="progress-stat"><div class="progress-stat-value" id="totalWords">0</div><div class="progress-stat-label">كلمات</div></div>
                        <div class="progress-stat"><div class="progress-stat-value" id="totalQuizzes">0</div><div class="progress-stat-label">اختبارات</div></div>
                        <div class="progress-stat"><div class="progress-stat-value" id="currentStreak">0</div><div class="progress-stat-label">🔥 أيام</div></div>
                        <div class="progress-stat"><div class="progress-stat-value" id="longestStreak">0</div><div class="progress-stat-label">أطول سلسلة</div></div>
                    </div>
                </div>
                <div class="progress-overview" onclick="openFavorites()" style="cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="progress-title">❤️ الكلمات المفضلة</div>
                        <div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 11px; color: var(--text-secondary);" id="likedCount">0 كلمات</span><i class="fas fa-chevron-left" style="color: var(--text-secondary); font-size: 12px;"></i></div>
                    </div>
                    <div id="likedWordsPreview" style="margin-top: 10px;"></div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home" onclick="navigateTo('home')"><i class="fas fa-home"></i><span>الرئيسية</span></button>
            <button class="nav-item" data-page="mywords" onclick="navigateTo('mywords')"><i class="fas fa-brain"></i><span>كلماتي</span></button>
            <button class="nav-item" data-page="grammar" onclick="navigateTo('grammar')"><i class="fas fa-book"></i><span>قواعد</span></button>
            <button class="nav-item" data-page="statistics" onclick="navigateTo('statistics')"><i class="fas fa-chart-bar"></i><span>إحصائيات</span></button>
            <button class="nav-item" data-page="profile" onclick="navigateTo('profile')"><i class="fas fa-user"></i><span>حسابي</span></button>
        </nav>
    </div>

<script>
// ==================== Helpers ====================
const debounce = (fn, delay) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), delay); }; };
const throttle = (fn, limit) => { let f; return (...a) => { if (!f) { fn(...a); f = true; setTimeout(() => f = false, limit); } }; };
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const escapeQuotes = str => str ? str.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';

// ==================== Config ====================
const CONFIG = {
    BASE_URL: 'https://raw.githubusercontent.com/ahmeddoghmish65/Itali-app-data/main/data/',
    CACHE_PREFIX: 'sahlitali_',
    CACHE_VERSION: 'v7',
    STATE_KEY: 'sahlitali_state_v16',
    CACHE_DURATION: 86400000
};

const SRS_CONFIG = {
    again: { interval: 0.007, ease: -0.2 },
    hard: { interval: 0.04, ease: -0.15 },
    good: { interval: 1, ease: 0 },
    easy: { interval: 4, ease: 0.15 }
};

const CATEGORY_ICONS = {
    greetings: 'hand-wave', numbers: 'hashtag', colors: 'palette', family: 'users', food: 'utensils',
    drinks: 'coffee', animals: 'paw', body: 'child', clothes: 'tshirt', house: 'home', weather: 'cloud-sun',
    time: 'clock', days: 'calendar-day', months: 'calendar-alt', professions: 'briefcase', transport: 'car',
    places: 'map-marker-alt', verbs: 'running', adjectives: 'star', questions: 'question-circle', default: 'folder'
};

const ACHIEVEMENTS = [
    { id: 'first_word', icon: '📚', title: 'الخطوة الأولى', desc: 'تعلم أول كلمة', xp: 10, condition: s => s.totalWordsLearned >= 1 },
    { id: 'ten_words', icon: '🎯', title: 'عشر كلمات', desc: 'تعلم 10 كلمات', xp: 25, condition: s => s.totalWordsLearned >= 10 },
    { id: 'fifty_words', icon: '🌟', title: 'خمسون كلمة', desc: 'تعلم 50 كلمة', xp: 50, condition: s => s.totalWordsLearned >= 50 },
    { id: 'hundred_words', icon: '💯', title: 'مئة كلمة', desc: 'تعلم 100 كلمة', xp: 100, condition: s => s.totalWordsLearned >= 100 },
    { id: 'first_quiz', icon: '📝', title: 'أول اختبار', desc: 'أكمل اختبارك الأول', xp: 15, condition: s => s.quizzesDone >= 1 },
    { id: 'five_quizzes', icon: '🧠', title: 'متعلم نشط', desc: 'أكمل 5 اختبارات', xp: 30, condition: s => s.quizzesDone >= 5 },
    { id: 'perfect_quiz', icon: '🏆', title: 'اختبار مثالي', desc: 'احصل على 100%', xp: 75, condition: s => s.perfectQuizzes >= 1 },
    { id: 'streak_3', icon: '🔥', title: 'ثلاثة أيام', desc: 'تعلم 3 أيام متتالية', xp: 20, condition: s => s.streak >= 3 },
    { id: 'streak_7', icon: '⚡', title: 'أسبوع كامل', desc: 'تعلم 7 أيام متتالية', xp: 50, condition: s => s.streak >= 7 },
    { id: 'xp_100', icon: '⭐', title: 'نجم صاعد', desc: 'اجمع 100 XP', xp: 20, condition: s => s.xp >= 100 },
    { id: 'xp_500', icon: '🌠', title: 'نجم متألق', desc: 'اجمع 500 XP', xp: 50, condition: s => s.xp >= 500 },
    { id: 'liked_10', icon: '❤️', title: 'محب الكلمات', desc: 'أضف 10 كلمات للمفضلة', xp: 25, condition: s => s.likedWords.length >= 10 }
];

// ==================== Database & State ====================
let DATABASE = { words: { a1: {}, a2: {}, b1: {}, b2: {} }, grammar: { a1: [], a2: [], b1: [], b2: [] }, phrases: { a1: [], a2: [], b1: [], b2: [] }, conversations: { a1: [], a2: [], b1: [], b2: [] } };
let APP_CONFIG = { app: { name: 'سهل إيطالي' }, social: {}, about: {}, contact: {}, privacy: {}, terms: {} };
let loadingStatus = { words: {}, grammar: {}, phrases: {}, conversations: {}, config: false };
['a1', 'a2', 'b1', 'b2'].forEach(l => { loadingStatus.words[l] = loadingStatus.grammar[l] = loadingStatus.phrases[l] = loadingStatus.conversations[l] = false; });

let appState = {
    currentLevel: 'a1', darkMode: false, soundEnabled: true, dailyGoal: 50, xp: 0, streak: 0, longestStreak: 0,
    userLevel: 1, dailyXP: 0, lastStudyDate: null, learnedWords: {}, quizzesDone: 0, perfectQuizzes: 0,
    totalCorrectAnswers: 0, totalQuizQuestions: 0, likedWords: [], wordOfDay: null, wordOfDayDate: null,
    unlockedAchievements: [], newAchievements: [], weeklyXP: [0,0,0,0,0,0,0], totalDaysLearned: 0,
    wodCollapsed: false, notifications: [], conversationSpeed: 1, selectedRole: 'A', conversationMode: 'listen',
    studySessions: [], sessionStartTime: null,
    // تعديل 4: نظام الهدف اليومي المتطور
    goalLevel: 1, goalCompletedDays: 0, lastGoalCompleted: null,
    // تعديل 5: تتبع العبارات والقواعد المتعلمة
    learnedPhrases: {}, learnedGrammar: {},
    // تعديل 1: حفظ موضع التمرير
    scrollPositions: {}
};

let currentWords = [], currentWordIndex = 0, currentCategory = null, previousPage = 'words';
let quizQuestions = [], currentQuizIndex = 0, quizScore = 0, quizType = 'words';
let exerciseWords = [], exerciseIndex = 0, exerciseScore = 0, exerciseType = '';
let matchingCards = [], firstSelectedCard = null, matchingLocked = false, matchedCount = 0, matchingMoves = 0;
let speedTimer = null, speedTimeLeft = 0, selectedLetters = [];
let currentConversation = null, conversationPlaying = false;
let myWordsFilter = 'all', myWordsLevelFilter = 'all';
let pendingDeleteWord = null, pendingAction = null, toastTimeout;

// ==================== تعديل 1: حفظ موضع التمرير ====================
function saveScrollPosition(pageId) {
    const mainContent = $('mainContent');
    if (mainContent) {
        appState.scrollPositions[pageId] = mainContent.scrollTop;
    }
}

function restoreScrollPosition(pageId) {
    const mainContent = $('mainContent');
    if (mainContent && appState.scrollPositions[pageId] !== undefined) {
        setTimeout(() => {
            mainContent.scrollTop = appState.scrollPositions[pageId];
        }, 50);
    }
}

function goBackWithScroll(targetPage) {
    // حفظ موضع الصفحة الحالية
    const currentPage = document.querySelector('.page.active');
    if (currentPage) {
        saveScrollPosition(currentPage.id);
    }
    
    // الانتقال للصفحة المطلوبة
    if (targetPage === 'home') {
        navigateTo('home');
    } else if (targetPage === 'profile') {
        navigateTo('profile');
    } else if (targetPage === 'phrases') {
        openSection('phrases');
    } else if (targetPage === 'conversations') {
        openSection('conversations');
    } else if (targetPage === 'grammar') {
        navigateTo('grammar');
    } else {
        navigateTo('home');
    }
    
    // استعادة موضع التمرير
    restoreScrollPosition(targetPage + 'Page');
}

// ==================== Data Loading ====================
const getCategoryIcon = (iconName, catId) => {
    if (iconName && /^[a-z-]+$/.test(iconName)) return iconName;
    if (catId) for (const [k, v] of Object.entries(CATEGORY_ICONS)) if (catId.toLowerCase().includes(k)) return v;
    return CATEGORY_ICONS.default;
};

async function loadConfig() {
    if (loadingStatus.config) return;
    try {
        const r = await fetch(`${CONFIG.BASE_URL}config.json`);
        if (r.ok) APP_CONFIG = { ...APP_CONFIG, ...(await r.json()) };
        loadingStatus.config = true;
    } catch (e) {}
}

async function loadDataFile(type, level) {
    if (loadingStatus[type][level]) return DATABASE[type][level];
    try {
        const r = await fetch(`${CONFIG.BASE_URL}${type}/${level}.json`);
        if (r.ok) DATABASE[type][level] = await r.json();
        loadingStatus[type][level] = true;
    } catch (e) { DATABASE[type][level] = getFallbackData(type, level); loadingStatus[type][level] = true; }
    return DATABASE[type][level];
}

async function loadCurrentLevelData() {
    await Promise.all(['words', 'phrases', 'grammar', 'conversations'].map(t => loadDataFile(t, appState.currentLevel)));
    updateUI(); updateCounts();
}

function getFallbackData(type, level) {
    if (type === 'words' && level === 'a1') return {
        greetings: { name: 'التحيات', icon: 'hand-wave', words: [
            { it: 'Ciao', ar: 'مرحباً', phonetic: '/ˈtʃaːo/', type: 'تحية', example: { it: 'Ciao!', ar: 'مرحباً!' } },
            { it: 'Grazie', ar: 'شكراً', phonetic: '/ˈɡrattsje/', type: 'تعبير', example: { it: 'Grazie mille!', ar: 'شكراً جزيلاً!' } }
        ]}
    };
    return type === 'words' ? {} : [];
}

// ==================== Init ====================
async function initApp() {
    loadState();
    if (appState.darkMode) document.body.classList.add('dark-mode');
    appState.sessionStartTime = Date.now();
    await loadConfig();
    await loadCurrentLevelData();
    setTimeout(() => ['a1','a2','b1','b2'].forEach(l => loadDataFile('words', l)), 500);
    $('loadingOverlay')?.classList.add('hide');
    initWordOfDay();
    initNotifications();
    checkAchievements();
    updateUI();
    updateDailyGoalUI();
    renderWeeklyChart();
    updateLevelProgressIndicators();
}

function loadState() {
    try { const s = localStorage.getItem(CONFIG.STATE_KEY); if (s) appState = { ...appState, ...JSON.parse(s) }; } catch (e) {}
    checkStreak();
    checkDailyGoalReset();
}

const saveState = debounce(() => { try { localStorage.setItem(CONFIG.STATE_KEY, JSON.stringify(appState)); } catch (e) {} }, 300);

// ==================== تعديل 4: نظام الهدف اليومي المتطور ====================
function checkDailyGoalReset() {
    const today = new Date().toDateString();
    if (appState.lastStudyDate !== today) {
        // يوم جديد - تحقق من إكمال الهدف بالأمس
        if (appState.lastGoalCompleted === appState.lastStudyDate && appState.dailyXP >= appState.dailyGoal) {
            appState.goalCompletedDays++;
            // ترقية مستوى الهدف كل 3 أيام مكتملة
            if (appState.goalCompletedDays > 0 && appState.goalCompletedDays % 3 === 0) {
                upgradeGoalLevel();
            }
        }
        appState.dailyXP = 0;
    }
}

function upgradeGoalLevel() {
    const goalLevels = [
        { level: 1, goal: 30, name: 'مبتدئ' },
        { level: 2, goal: 50, name: 'نشط' },
        { level: 3, goal: 75, name: 'متحمس' },
        { level: 4, goal: 100, name: 'جاد' },
        { level: 5, goal: 150, name: 'متقدم' },
        { level: 6, goal: 200, name: 'محترف' },
        { level: 7, goal: 250, name: 'خبير' },
        { level: 8, goal: 300, name: 'أسطوري' }
    ];
    
    if (appState.goalLevel < goalLevels.length) {
        appState.goalLevel++;
        const newLevel = goalLevels[appState.goalLevel - 1];
        appState.dailyGoal = newLevel.goal;
        showToast(`🎯 ترقية! هدفك الجديد: ${newLevel.goal} XP (${newLevel.name})`, 'success');
        addNotification('level', `ترقية الهدف! 🎯`, `مستوى ${newLevel.name}: ${newLevel.goal} XP`, Date.now());
        saveState();
    }
}

function updateDailyGoalUI() {
    const goalLevels = [
        { level: 1, name: 'مبتدئ' },
        { level: 2, name: 'نشط' },
        { level: 3, name: 'متحمس' },
        { level: 4, name: 'جاد' },
        { level: 5, name: 'متقدم' },
        { level: 6, name: 'محترف' },
        { level: 7, name: 'خبير' },
        { level: 8, name: 'أسطوري' }
    ];
    
    const currentGoalLevel = goalLevels[appState.goalLevel - 1] || goalLevels[0];
    
    const badge = $('goalLevelBadge');
    if (badge) badge.textContent = `المستوى ${appState.goalLevel} - ${currentGoalLevel.name}`;
    
    const streak = $('goalStreak');
    if (streak) streak.textContent = appState.streak;
    
    const completedDays = $('goalCompletedDays');
    if (completedDays) completedDays.textContent = `أيام مكتملة: ${appState.goalCompletedDays}`;
}

// ==================== Navigation ====================
function navigateTo(page) {
    // حفظ موضع الصفحة الحالية
    const currentPage = document.querySelector('.page.active');
    if (currentPage) {
        saveScrollPosition(currentPage.id);
    }
    
    $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
    $$('.page').forEach(p => p.classList.remove('active'));
    speechSynthesis.cancel();
    stopConversation();
    const actions = {
        home: () => { $('homePage').classList.add('active'); restoreScrollPosition('homePage'); },
        mywords: () => { $('myWordsPage').classList.add('active'); renderMyWords(); restoreScrollPosition('myWordsPage'); },
        grammar: () => { $('grammarPage').classList.add('active'); renderGrammar(); restoreScrollPosition('grammarPage'); },
        statistics: () => { $('statisticsPage').classList.add('active'); renderStatistics(); restoreScrollPosition('statisticsPage'); },
        profile: () => { $('profilePage').classList.add('active'); updateProfile(); restoreScrollPosition('profilePage'); }
    };
    actions[page]?.();
}

function goHome() { navigateTo('home'); }

function openSection(section) {
    // حفظ موضع الصفحة الحالية
    const currentPage = document.querySelector('.page.active');
    if (currentPage) {
        saveScrollPosition(currentPage.id);
    }
    
    $$('.page').forEach(p => p.classList.remove('active'));
    speechSynthesis.cancel();
    const actions = {
        words: () => { $('wordsPage').classList.add('active'); renderWordCategories(); previousPage = 'words'; restoreScrollPosition('wordsPage'); },
        phrases: () => { $('phrasesPage').classList.add('active'); renderPhrases(); restoreScrollPosition('phrasesPage'); },
        conversations: () => { $('conversationsPage').classList.add('active'); renderConversations(); restoreScrollPosition('conversationsPage'); },
        grammar: () => { $('grammarPage').classList.add('active'); renderGrammar(); restoreScrollPosition('grammarPage'); },
        quiz: () => { $('quizTypePage').classList.add('active'); restoreScrollPosition('quizTypePage'); },
        practice: () => { $('practicePage').classList.add('active'); restoreScrollPosition('practicePage'); },
        achievements: () => { $('achievementsPage').classList.add('active'); renderAchievements(); restoreScrollPosition('achievementsPage'); }
    };
    actions[section]?.();
}

function goBackFromStudy() {
    $$('.page').forEach(p => p.classList.remove('active'));
    if (previousPage === 'mywords') { 
        $('myWordsPage').classList.add('active'); 
        renderMyWords(); 
        restoreScrollPosition('myWordsPage');
    }
    else if (currentCategory === 'favorites') { 
        $('favoritesPage').classList.add('active'); 
        restoreScrollPosition('favoritesPage');
    }
    else { 
        $('wordsPage').classList.add('active'); 
        renderWordCategories(); 
        restoreScrollPosition('wordsPage');
    }
}

// ==================== Level Selection ====================
function updateLevelTabsUI(level) {
    $$('.level-tab').forEach(t => t.classList.toggle('active', t.dataset.level === level));
    $$('.current-level-text').forEach(el => el.textContent = level.toUpperCase());
    const d = $('currentLevelDisplay'); if (d) d.textContent = level.toUpperCase();
    const b = $('levelProgressBar'); if (b) b.className = `progress-bar-fill ${level}`;
}

async function selectLevel(level) {
    if (appState.currentLevel === level) return;
    appState.currentLevel = level;
    saveState();
    updateLevelTabsUI(level);
    await loadCurrentLevelData();
    showToast(`تم التبديل للمستوى ${level.toUpperCase()}`, 'success');
}

function updateLevelProgressIndicators() {
    ['a1','a2','b1','b2'].forEach(l => {
        const el = $(`levelProgress${l.toUpperCase()}`);
        if (el) el.style.width = `${calculateLevelProgress(l)}%`;
    });
}

function calculateLevelProgress(level) {
    let total = 0, learned = 0;
    Object.entries(DATABASE.words[level] || {}).forEach(([catId, cat]) => {
        if (cat.words) { total += cat.words.length; learned += Object.keys(appState.learnedWords[`${level}_${catId}`] || {}).length; }
    });
    return total > 0 ? Math.round((learned / total) * 100) : 0;
}

// ==================== Word of Day ====================
function initWordOfDay() {
    const today = new Date().toDateString();
    if (appState.wordOfDayDate !== today) {
        const words = getAllWordsFlat();
        const day = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
        appState.wordOfDay = words.length ? words[day % words.length] : { it: 'Ciao', ar: 'مرحباً', phonetic: '/ˈtʃaːo/' };
        appState.wordOfDayDate = today;
        appState.wodCollapsed = false;
        saveState();
    }
    displayWordOfDay();
    if (appState.wodCollapsed) { $('wordOfDay')?.classList.add('collapsed'); $('wodToggleIcon')?.classList.replace('fa-chevron-up', 'fa-chevron-down'); }
}

function getAllWordsFlat() {
    const words = [];
    Object.keys(DATABASE.words).forEach(l => Object.entries(DATABASE.words[l]).forEach(([cId, c]) => c.words?.forEach(w => words.push({ ...w, level: l, categoryId: cId }))));
    return words;
}

function getCurrentLevelWords() {
    const words = [];
    Object.entries(DATABASE.words[appState.currentLevel] || {}).forEach(([cId, c]) => c.words?.forEach(w => words.push({ ...w, level: appState.currentLevel, categoryId: cId })));
    return words;
}

function displayWordOfDay() {
    const w = appState.wordOfDay; if (!w) return;
    const set = (id, v) => { const el = $(id); if (el) el.textContent = v; };
    set('wodItalian', w.it); set('wodArabic', w.ar); set('wodPhonetic', w.phonetic || ''); set('wodType', w.type || 'كلمة');
    set('wodCollapsedWord', w.it); set('wodCollapsedMeaning', w.ar);
    if (w.example) { set('wodExampleIt', w.example.it); set('wodExampleAr', w.example.ar); }
    set('wodDate', new Date().toLocaleDateString('ar', { weekday: 'long', day: 'numeric', month: 'long' }));
    updateWodLikeBtn();
}

function toggleWordOfDay(e) {
    e?.stopPropagation();
    const wod = $('wordOfDay'), icon = $('wodToggleIcon');
    wod.classList.toggle('collapsed');
    appState.wodCollapsed = wod.classList.contains('collapsed');
    icon.classList.toggle('fa-chevron-up', !appState.wodCollapsed);
    icon.classList.toggle('fa-chevron-down', appState.wodCollapsed);
    saveState();
}

function speakWordOfDay(e) { e?.stopPropagation(); if (appState.wordOfDay) speak(appState.wordOfDay.it); }
function toggleLikeWordOfDay(e) { e?.stopPropagation(); if (appState.wordOfDay) { toggleLikeWord(appState.wordOfDay); updateWodLikeBtn(); } }

function updateWodLikeBtn() {
    const w = appState.wordOfDay, btn = $('wodLikeBtn'); if (!w || !btn) return;
    const liked = appState.likedWords.some(x => x.it === w.it);
    btn.innerHTML = `<i class="${liked ? 'fas' : 'far'} fa-heart"></i>`;
    btn.classList.toggle('liked', liked);
}

// ==================== Like System ====================
function toggleLikeWord(word) {
    const idx = appState.likedWords.findIndex(w => w.it === word.it);
    if (idx === -1) { appState.likedWords.push({ ...word }); showToast('❤️ تمت الإضافة للمفضلة', 'success'); }
    else { appState.likedWords.splice(idx, 1); showToast('تمت الإزالة من المفضلة', 'info'); }
    checkAchievements(); saveState();
}

const isWordLiked = word => appState.likedWords.some(w => w.it === word.it);

// ==================== تعديل 3: زر المفضلة في الفلاش كارد ====================
function toggleCurrentWordFavorite() {
    if (!currentWords.length) return;
    const word = currentWords[currentWordIndex];
    toggleLikeWord(word);
    updateWordFavoriteBtn();
}

function updateWordFavoriteBtn() {
    if (!currentWords.length) return;
    const word = currentWords[currentWordIndex];
    const btn = $('wordFavoriteBtn');
    if (btn) {
        const liked = isWordLiked(word);
        btn.innerHTML = `<i class="${liked ? 'fas' : 'far'} fa-heart"></i>`;
        btn.classList.toggle('liked', liked);
    }
}

// ==================== تعديل 2: إصلاح عداد الكلمات في كلماتي ====================
function updateMyWordsStats() {
    const counts = { again: 0, hard: 0, good: 0, easy: 0 };
    
    // المرور على جميع الكلمات المتعلمة وحساب كل تصنيف
    ['a1', 'a2', 'b1', 'b2'].forEach(level => {
        Object.entries(DATABASE.words[level] || {}).forEach(([catId, cat]) => {
            const key = `${level}_${catId}`;
            const learned = appState.learnedWords[key] || {};
            Object.values(learned).forEach(data => {
                if (data.lastRating && counts.hasOwnProperty(data.lastRating)) {
                    counts[data.lastRating]++;
                }
            });
        });
    });
    
    // تحديث العرض
    const againEl = $('myWordsAgainCount');
    const hardEl = $('myWordsHardCount');
    const goodEl = $('myWordsGoodCount');
    const easyEl = $('myWordsEasyCount');
    
    if (againEl) againEl.textContent = counts.again;
    if (hardEl) hardEl.textContent = counts.hard;
    if (goodEl) goodEl.textContent = counts.good;
    if (easyEl) easyEl.textContent = counts.easy;
    
    // تحديث الكلمات المستحقة
    const all = getAllRatedWords();
    const due = all.filter(w => !w.nextReview || new Date(w.nextReview) <= new Date()).length;
    const badge = $('dueWordsBadge');
    if (badge) { badge.textContent = due; badge.style.display = due > 0 ? 'flex' : 'none'; }
}

function renderMyWords() {
    updateMyWordsStats();
    const container = $('myWordsContent'); if (!container) return;
    const allWords = getAllRatedWords();
    let filtered = allWords;
    if (myWordsFilter !== 'all') filtered = filtered.filter(w => w.lastRating === myWordsFilter);
    if (myWordsLevelFilter !== 'all') filtered = filtered.filter(w => w.level === myWordsLevelFilter);

    $$('.my-words-stat').forEach(s => { 
        const classList = Array.from(s.classList);
        const rating = classList.find(c => ['again', 'hard', 'good', 'easy'].includes(c));
        s.classList.toggle('active', myWordsFilter === rating); 
    });

    if (!filtered.length) {
        container.innerHTML = allWords.length === 0 ?
            `<div class="my-words-empty"><div class="my-words-empty-icon">📚</div><div class="my-words-empty-title">لا توجد كلمات بعد</div><div class="my-words-empty-text">ابدأ بتعلم الكلمات وتقييمها</div><button class="word-control-btn primary" onclick="openSection('words')" style="margin: 0 auto;"><i class="fas fa-play"></i> ابدأ</button></div>` :
            `<div class="my-words-empty"><div class="my-words-empty-icon">🔍</div><div class="my-words-empty-title">لا توجد نتائج</div><button class="word-control-btn secondary" onclick="resetMyWordsFilters()" style="margin: 0 auto;"><i class="fas fa-undo"></i> إعادة</button></div>`;
        return;
    }

    if (myWordsFilter === 'all') {
        const groups = { again: [], hard: [], good: [], easy: [] };
        filtered.forEach(w => { if (groups[w.lastRating]) groups[w.lastRating].push(w); });
        const titles = { again: '🔄 تحتاج إعادة', hard: '💪 صعبة', good: '👍 جيدة', easy: '⭐ سهلة' };
        const colors = { again: 'var(--danger)', hard: 'var(--warning)', good: 'var(--info)', easy: 'var(--success)' };
        let html = '';
        ['again', 'hard', 'good', 'easy'].forEach(r => {
            if (groups[r].length) {
                html += `<div class="my-words-section"><div class="my-words-section-header"><div class="my-words-section-title" style="color: ${colors[r]};">${titles[r]}</div><div class="my-words-section-count">${groups[r].length} كلمة</div></div>${groups[r].slice(0, 5).map(w => renderMyWordCard(w)).join('')}${groups[r].length > 5 ? `<button class="word-control-btn secondary" onclick="filterMyWords('${r}')" style="width: 100%; margin-top: 5px;">عرض الكل (${groups[r].length})</button>` : ''}</div>`;
            }
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = filtered.map(w => renderMyWordCard(w)).join('');
    }
}

function renderMyWordCard(word) {
    const icons = { again: '🔄', hard: '💪', good: '👍', easy: '⭐' };
    const nextText = getNextReviewText(word.nextReview);
    return `<div class="my-word-card ${word.lastRating}"><div class="my-word-rating">${icons[word.lastRating] || '📚'}</div><div class="my-word-info"><div class="my-word-italian">${word.it}</div><div class="my-word-arabic">${word.ar}</div><div class="my-word-meta"><span class="my-word-level ${word.level}">${word.level.toUpperCase()}</span><span class="my-word-next-review"><i class="fas fa-clock"></i> ${nextText}</span>${word.correctCount > 0 ? `<span class="my-word-streak">🔥 ${word.correctCount}</span>` : ''}</div></div><div class="my-word-actions"><button class="my-word-btn speak" onclick="event.stopPropagation(); speak('${escapeQuotes(word.it)}')"><i class="fas fa-volume-up"></i></button><button class="my-word-btn study" onclick="event.stopPropagation(); studySingleWord('${escapeQuotes(word.it)}', '${word.level}', '${word.categoryId}')"><i class="fas fa-play"></i></button></div></div>`;
}

function getNextReviewText(nextReview) {
    if (!nextReview) return 'الآن';
    const diff = new Date(nextReview) - new Date();
    if (diff <= 0) return 'مستحقة';
    const mins = Math.round(diff / 60000);
    const hours = Math.round(diff / 3600000);
    const days = Math.round(diff / 86400000);
    if (mins < 60) return `بعد ${mins} د`;
    if (hours < 24) return `بعد ${hours} س`;
    if (days === 1) return 'غداً';
    if (days < 7) return `بعد ${days} أيام`;
    return `بعد ${Math.round(days / 7)} أسبوع`;
}

function getAllRatedWords() {
    const words = [];
    ['a1', 'a2', 'b1', 'b2'].forEach(level => {
        Object.entries(DATABASE.words[level] || {}).forEach(([catId, cat]) => {
            const key = `${level}_${catId}`;
            const learned = appState.learnedWords[key] || {};
            Object.entries(learned).forEach(([wordIt, data]) => {
                const orig = cat.words?.find(w => w.it === wordIt);
                if (orig && data.lastRating) words.push({ ...orig, level, categoryId: catId, ...data });
            });
        });
    });
    words.sort((a, b) => new Date(a.nextReview || 0) - new Date(b.nextReview || 0));
    return words;
}

function filterMyWords(rating) { myWordsFilter = myWordsFilter === rating ? 'all' : rating; renderMyWords(); }

function filterMyWordsByLevel(level) {
    myWordsLevelFilter = level;
    $$('.level-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.level === level));
    renderMyWords();
}

function resetMyWordsFilters() {
    myWordsFilter = 'all'; myWordsLevelFilter = 'all';
    $$('.level-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.level === 'all'));
    $$('.my-words-stat').forEach(s => s.classList.remove('active'));
    renderMyWords();
}

function startReviewSession() {
    const difficult = getAllRatedWords().filter(w => w.lastRating === 'again' || w.lastRating === 'hard');
    if (!difficult.length) { showToast('🎉 لا توجد كلمات صعبة!', 'success'); return; }
    currentWords = difficult.sort(() => Math.random() - 0.5).slice(0, 20);
    currentWordIndex = 0; currentCategory = 'review'; previousPage = 'mywords';
    $('wordCategoryTitle').textContent = '🔄 مراجعة الكلمات الصعبة';
    $$('.page').forEach(p => p.classList.remove('active'));
    $('wordStudyPage').classList.add('active');
    displayCurrentWord();
}

function studyDueWords() {
    const due = getAllRatedWords().filter(w => !w.nextReview || new Date(w.nextReview) <= new Date());
    if (!due.length) { showToast('✅ لا توجد كلمات مستحقة', 'info'); return; }
    currentWords = due.slice(0, 20);
    currentWordIndex = 0; currentCategory = 'due'; previousPage = 'mywords';
    $('wordCategoryTitle').textContent = `📖 مراجعة مستحقة (${due.length})`;
    $$('.page').forEach(p => p.classList.remove('active'));
    $('wordStudyPage').classList.add('active');
    displayCurrentWord();
}

function studySingleWord(wordIt, level, categoryId) {
    const cat = DATABASE.words[level]?.[categoryId];
    const word = cat?.words?.find(w => w.it === wordIt);
    if (!word) return;
    currentWords = [{ ...word, level, categoryId }];
    currentWordIndex = 0; currentCategory = categoryId; previousPage = 'mywords';
    $('wordCategoryTitle').textContent = word.it;
    $$('.page').forEach(p => p.classList.remove('active'));
    $('wordStudyPage').classList.add('active');
    displayCurrentWord();
}

const searchMyWords = debounce(() => {
    const q = $('myWordsSearch')?.value.trim().toLowerCase();
    if (!q) { renderMyWords(); return; }
    const filtered = getAllRatedWords().filter(w => w.it.toLowerCase().includes(q) || w.ar.includes(q));
    const container = $('myWordsContent');
    container.innerHTML = filtered.length ? filtered.map(w => renderMyWordCard(w)).join('') :
        `<div class="my-words-empty"><div class="my-words-empty-icon">🔍</div><div class="my-words-empty-title">لا توجد نتائج</div></div>`;
}, 250);

// ==================== Words ====================
function renderWordCategories() {
    const container = $('wordsCategoryList');
    const data = DATABASE.words[appState.currentLevel] || {};
    const cats = Object.keys(data);
    if (!cats.length) { container.innerHTML = '<div class="empty-state"><i class="fas fa-book-open"></i><p>لا توجد كلمات</p></div>'; return; }
    container.innerHTML = cats.map(catId => {
        const cat = data[catId];
        const count = cat.words?.length || 0;
        const learned = Object.keys(appState.learnedWords[`${appState.currentLevel}_${catId}`] || {}).length;
        const progress = count > 0 ? Math.round((learned / count) * 100) : 0;
        return `<div class="category-item" onclick="openWordCategory('${catId}')"><div class="category-icon" style="background: linear-gradient(135deg, var(--a1-color), #4ADE80); color: white;"><i class="fas fa-${getCategoryIcon(cat.icon, catId)}"></i></div><div class="category-info"><div class="category-name">${cat.name}</div><div class="category-meta">${count} كلمة • ${learned} تعلمتها</div></div><div class="category-progress-value">${progress}%</div><i class="fas fa-chevron-left category-arrow"></i></div>`;
    }).join('');
}

function openWordCategory(catId) {
    const data = DATABASE.words[appState.currentLevel];
    if (!data?.[catId]) return;
    currentCategory = catId; previousPage = 'words';
    currentWords = [...data[catId].words].map(w => ({ ...w, level: appState.currentLevel, categoryId: catId }));
    currentWordIndex = 0;
    $('wordCategoryTitle').textContent = data[catId].name;
    $$('.page').forEach(p => p.classList.remove('active'));
    $('wordStudyPage').classList.add('active');
    displayCurrentWord();
}

function displayCurrentWord() {
    if (!currentWords.length) return;
    const word = currentWords[currentWordIndex];
    $('wordCard')?.classList.remove('flipped');
    $('wordItalian').textContent = word.it;
    $('wordArabic').textContent = word.ar;
    $('wordPhonetic').textContent = word.phonetic || '';
    $('wordTypeBadge').textContent = word.type || 'كلمة';
    const level = word.level || appState.currentLevel;
    const badge = $('wordLevelBadge');
    badge.textContent = level.toUpperCase() + (word.isRepeat ? ' 🔄' : '');
    badge.className = `word-level-badge ${level}`;
    const example = $('wordExample');
    example.innerHTML = word.example ? `<span class="italian-example">${word.example.it}</span><br><small>${word.example.ar}</small>` : '';
    $('wordProgress').textContent = `${currentWordIndex + 1}/${currentWords.length}`;
    updateRatingPreviews(word);
    updateWordFavoriteBtn();
}

function updateRatingPreviews(word) {
    const key = `${word.level || appState.currentLevel}_${word.categoryId || currentCategory}`;
    const data = appState.learnedWords[key]?.[word.it];
    const interval = data?.interval || 0;
    const ease = data?.ease || 2.5;
    const times = [
        '< 10 د',
        formatInterval(Math.max(0.04, interval * 1.2)),
        formatInterval(Math.max(1, interval * ease)),
        formatInterval(Math.max(4, interval * ease * 1.3))
    ];
    $$('.rating-btn .interval-preview').forEach((el, i) => el.textContent = times[i]);
}

function formatInterval(days) {
    if (days < 0.04) return '< 1 س';
    if (days < 1) return `${Math.round(days * 24)} س`;
    if (days < 7) return `${Math.round(days)} أيام`;
    if (days < 30) return `${Math.round(days / 7)} أسبوع`;
    return `${Math.round(days / 30)} شهر`;
}

function flipCard() { $('wordCard')?.classList.toggle('flipped'); }
function handleNextWord() { if (currentWordIndex < currentWords.length - 1) { currentWordIndex++; displayCurrentWord(); } else showToast('🎉 انتهيت!', 'success'); }
function handlePrevWord() { if (currentWordIndex > 0) { currentWordIndex--; displayCurrentWord(); } }
function shuffleWords() { currentWords.sort(() => Math.random() - 0.5); currentWordIndex = 0; displayCurrentWord(); showToast('🔀 تم الخلط', 'info'); }
function speakCurrentWord() { if (currentWords.length) speak(currentWords[currentWordIndex].it); }

function rateWord(rating) {
    if (!currentWords.length) return;
    const word = currentWords[currentWordIndex];
    const level = word.level || appState.currentLevel;
    const key = `${level}_${word.categoryId || currentCategory}`;
    if (!appState.learnedWords[key]) appState.learnedWords[key] = {};

    let data = appState.learnedWords[key][word.it] || { ease: 2.5, interval: 0, repetitions: 0, correctCount: 0 };
    const cfg = SRS_CONFIG[rating];

    if (rating === 'again') {
        data.interval = cfg.interval; data.repetitions = 0; data.ease = Math.max(1.3, data.ease + cfg.ease);
    } else {
        if (data.repetitions === 0) data.interval = rating === 'easy' ? 4 : rating === 'good' ? 1 : 0.04;
        else if (data.repetitions === 1) data.interval = rating === 'easy' ? 8 : rating === 'good' ? 6 : 1;
        else data.interval = Math.round(data.interval * data.ease * (rating === 'easy' ? 1.3 : rating === 'good' ? 1 : 0.8));
        data.ease = Math.max(1.3, data.ease + cfg.ease);
        data.repetitions++;
        if (rating === 'good' || rating === 'easy') data.correctCount = (data.correctCount || 0) + 1;
    }

    data.nextReview = new Date(Date.now() + data.interval * 86400000).toISOString();
    data.lastRating = rating;
    data.lastReview = new Date().toISOString();
    appState.learnedWords[key][word.it] = data;

    const xp = { again: 1, hard: 3, good: 5, easy: 10 }[rating];
    addXP(xp);

    const msgs = { again: '🔄 ستراها قريباً', hard: '💪 بحاجة تدريب', good: '👍 أحسنت!', easy: '⭐ ممتاز!' };
    showToast(msgs[rating], rating === 'easy' ? 'success' : 'info');

    if (rating === 'again' && currentWordIndex < currentWords.length - 1) {
        const pos = Math.min(currentWordIndex + 3 + Math.floor(Math.random() * 3), currentWords.length);
        currentWords.splice(pos, 0, { ...word, isRepeat: true });
    }

    if (currentWordIndex < currentWords.length - 1) { currentWordIndex++; displayCurrentWord(); }
    else showToast('🎉 أكملت المجموعة!', 'success');
    saveState();
}

const searchWords = debounce(() => {
    const q = $('wordSearch')?.value.trim().toLowerCase();
    if (!q) { renderWordCategories(); return; }
    const results = [];
    Object.values(DATABASE.words[appState.currentLevel] || {}).forEach(cat => cat.words?.forEach(w => {
        if (w.it.toLowerCase().includes(q) || w.ar.includes(q)) results.push(w);
    }));
    const container = $('wordsCategoryList');
    container.innerHTML = results.length ? results.slice(0, 30).map(w =>
        `<div class="category-item" onclick="speak('${escapeQuotes(w.it)}')"><div class="category-icon" style="background: var(--primary); color: white;"><i class="fas fa-font"></i></div><div class="category-info"><div class="category-name italian-text">${w.it}</div><div class="category-meta">${w.ar}</div></div><i class="fas fa-volume-up category-arrow"></i></div>`
    ).join('') : '<div class="empty-state"><i class="fas fa-search"></i><p>لا توجد نتائج</p></div>';
}, 250);

// ==================== Favorites ====================
function openFavorites() {
    saveScrollPosition('profilePage');
    $$('.page').forEach(p => p.classList.remove('active'));
    $('favoritesPage').classList.add('active');
    renderFavorites();
}

function renderFavorites() {
    const container = $('favoritesList');
    $('favoritesCount').textContent = appState.likedWords.length;
    if (!appState.likedWords.length) {
        container.innerHTML = `<div class="favorites-empty"><i class="far fa-heart"></i><p>لا توجد كلمات في المفضلة</p><button class="word-control-btn primary" onclick="openSection('words')" style="margin: 0 auto;"><i class="fas fa-plus"></i> أضف كلمات</button></div>`;
        return;
    }
    container.innerHTML = appState.likedWords.map((w, i) =>
        `<div class="liked-word-item"><div class="liked-word-icon">❤️</div><div class="liked-word-info"><div class="liked-word-it">${w.it}</div><div class="liked-word-ar">${w.ar}</div>${w.level ? `<span class="liked-word-level ${w.level}">${w.level.toUpperCase()}</span>` : ''}</div><div class="liked-word-actions"><button class="liked-word-btn speak" onclick="speak('${escapeQuotes(w.it)}')"><i class="fas fa-volume-up"></i></button><button class="liked-word-btn delete" onclick="confirmDeleteLikedWord(${i})"><i class="fas fa-trash"></i></button></div></div>`
    ).join('');
}

function studyFavorites() {
    if (!appState.likedWords.length) { showToast('لا توجد كلمات', 'warning'); return; }
    currentWords = [...appState.likedWords]; currentWordIndex = 0; currentCategory = 'favorites'; previousPage = 'profile';
    $('wordCategoryTitle').textContent = '❤️ المفضلة';
    $$('.page').forEach(p => p.classList.remove('active'));
    $('wordStudyPage').classList.add('active');
    displayCurrentWord();
}

function quizFavorites() {
    if (appState.likedWords.length < 4) { showToast('تحتاج 4 كلمات على الأقل', 'warning'); return; }
    quizType = 'favorites';
    quizQuestions = generateQuizFromWords(appState.likedWords);
    currentQuizIndex = 0; quizScore = 0;
    $('quizContainer').style.display = 'block'; $('quizResult').style.display = 'none';
    $('quizTotalQ').textContent = quizQuestions.length;
    $('quizListeningBtn').style.display = 'none';
    $$('.page').forEach(p => p.classList.remove('active'));
    $('quizPage').classList.add('active');
    displayQuizQuestion();
}

function generateQuizFromWords(words) {
    let qs = words.map(w => ({ question: `ما معنى "<span class="italian-word">${w.it}</span>"؟`, correct: w.ar, allAnswers: words.map(x => x.ar), audio: w.it }));
    qs = qs.sort(() => Math.random() - 0.5).slice(0, 10);
    qs.forEach(q => {
        const wrong = q.allAnswers.filter(a => a !== q.correct).sort(() => Math.random() - 0.5).slice(0, 3);
        q.options = [q.correct, ...wrong].sort(() => Math.random() - 0.5);
    });
    return qs;
}

// ==================== Phrases ====================
function renderPhrases() {
    const container = $('phrasesList');
    const phrases = DATABASE.phrases[appState.currentLevel] || [];
    if (!phrases.length) { container.innerHTML = '<div class="empty-state"><i class="fas fa-comment"></i><p>لا توجد عبارات</p></div>'; return; }
    container.innerHTML = phrases.map(p =>
        `<div class="category-item" onclick="openPhraseCategory('${p.id}')"><div class="category-icon" style="background: linear-gradient(135deg, var(--a2-color), #60A5FA); color: white;"><i class="fas fa-${getCategoryIcon(p.icon, p.id)}"></i></div><div class="category-info"><div class="category-name">${p.title}</div><div class="category-meta">${p.phrases?.length || 0} عبارة</div></div><i class="fas fa-chevron-left category-arrow"></i></div>`
    ).join('');
}

function openPhraseCategory(id) {
    saveScrollPosition('phrasesPage');
    const cat = (DATABASE.phrases[appState.currentLevel] || []).find(p => p.id === id);
    if (!cat) return;
    
    // تعديل 5: تسجيل تعلم العبارات
    const phraseKey = `${appState.currentLevel}_${id}`;
    if (!appState.learnedPhrases[phraseKey]) {
        appState.learnedPhrases[phraseKey] = { learned: true, date: new Date().toISOString() };
        saveState();
    }
    
    $('phraseDetailTitle').textContent = cat.title;
    $('phraseDetailContent').innerHTML = cat.phrases.map(p =>
        `<div class="phrase-card"><div class="phrase-card-header"><div><div class="phrase-italian">${p.it}</div><div class="phrase-arabic">${p.ar}</div><div class="phrase-phonetic">${p.phonetic || ''}</div></div><button class="phrase-speak-btn" onclick="speak('${escapeQuotes(p.it)}')"><i class="fas fa-volume-up"></i></button></div></div>`
    ).join('');
    $$('.page').forEach(p => p.classList.remove('active'));
    $('phraseDetailPage').classList.add('active');
    addXP(2);
}

// ==================== Conversations ====================
function renderConversations() {
    const container = $('conversationsList');
    const convs = DATABASE.conversations[appState.currentLevel] || [];
    if (!convs.length) { container.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>لا توجد محادثات</p></div>'; return; }
    container.innerHTML = convs.map(c =>
        `<div class="category-item" onclick="openConversation('${c.id}')"><div class="category-icon" style="background: linear-gradient(135deg, var(--b1-color), #FBBF24); color: white;"><i class="fas fa-${getCategoryIcon(c.icon, c.id)}"></i></div><div class="category-info"><div class="category-name">${c.title}</div><div class="category-meta">${c.dialogue?.length || 0} جملة</div></div><i class="fas fa-chevron-left category-arrow"></i></div>`
    ).join('');
}

function openConversation(id) {
    saveScrollPosition('conversationsPage');
    const conv = (DATABASE.conversations[appState.currentLevel] || []).find(c => c.id === id);
    if (!conv) return;
    currentConversation = conv;
    $('conversationDetailTitle').textContent = conv.title;
    renderConversationContent();
    $$('.page').forEach(p => p.classList.remove('active'));
    $('conversationDetailPage').classList.add('active');
    addXP(3);
}

function renderConversationContent() {
    if (!currentConversation) return;
    let html = '<div class="conversation-container">';
    currentConversation.dialogue.forEach((line, i) => {
        html += `<div class="conversation-bubble person-${line.speaker.toLowerCase()}" id="conv-line-${i}"><button class="conversation-speak-btn" onclick="speakLine(${i})"><i class="fas fa-volume-up"></i></button><div class="conversation-speaker"><span class="conversation-speaker-avatar">${line.speaker}</span>${line.name}</div><div class="conversation-text-it">${line.it}</div><div class="conversation-text-ar">${line.ar}</div></div>`;
    });
    html += '</div>';
    html += `<div class="conversation-controls"><div class="conversation-speed-control"><span class="conversation-speed-label">السرعة:</span><button class="conversation-speed-btn ${appState.conversationSpeed === 0.6 ? 'active' : ''}" onclick="setSpeed(0.6)">🐢</button><button class="conversation-speed-btn ${appState.conversationSpeed === 0.8 ? 'active' : ''}" onclick="setSpeed(0.8)">🚶</button><button class="conversation-speed-btn ${appState.conversationSpeed === 1 ? 'active' : ''}" onclick="setSpeed(1)">🏃</button></div><button class="conversation-play-btn ${conversationPlaying ? 'playing' : ''}" onclick="toggleConversation()" id="playConvBtn"><i class="fas fa-${conversationPlaying ? 'stop' : 'play'}"></i> ${conversationPlaying ? 'إيقاف' : 'تشغيل'}</button><div class="conversation-progress-bar"><div class="conversation-progress-fill" id="convProgressFill" style="width: 0%"></div></div></div>`;
    $('conversationDetailContent').innerHTML = html;
}

function speakLine(i) {
    const line = currentConversation?.dialogue[i];
    if (line) { speak(line.it, appState.conversationSpeed); highlightLine(i); }
}

function highlightLine(i) {
    $$('.conversation-bubble').forEach(el => el.classList.remove('highlighted'));
    $(`conv-line-${i}`)?.classList.add('highlighted');
    const fill = $('convProgressFill');
    if (fill && currentConversation) fill.style.width = `${((i + 1) / currentConversation.dialogue.length) * 100}%`;
}

function setSpeed(s) {
    appState.conversationSpeed = s; saveState();
    $$('.conversation-speed-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
}

function toggleConversation() { conversationPlaying ? stopConversation() : playConversation(); }

async function playConversation() {
    if (!currentConversation || conversationPlaying) return;
    conversationPlaying = true;
    const btn = $('playConvBtn');
    if (btn) { btn.innerHTML = '<i class="fas fa-stop"></i> إيقاف'; btn.classList.add('playing'); }
    for (let i = 0; i < currentConversation.dialogue.length && conversationPlaying; i++) {
        highlightLine(i);
        await speakAndWait(currentConversation.dialogue[i].it, appState.conversationSpeed);
        if (!conversationPlaying) break;
        await new Promise(r => setTimeout(r, 1500 / appState.conversationSpeed));
    }
    if (conversationPlaying) showToast('🎉 انتهت المحادثة!', 'success');
    stopConversation();
}

function speakAndWait(text, rate) {
    return new Promise(resolve => {
        if (!appState.soundEnabled || !('speechSynthesis' in window)) { resolve(); return; }
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'it-IT'; u.rate = rate;
        u.onend = resolve; u.onerror = resolve;
        speechSynthesis.speak(u);
    });
}

function stopConversation() {
    conversationPlaying = false;
    speechSynthesis.cancel();
    const btn = $('playConvBtn');
    if (btn) { btn.innerHTML = '<i class="fas fa-play"></i> تشغيل'; btn.classList.remove('playing'); }
    $$('.conversation-bubble').forEach(el => el.classList.remove('highlighted'));
}

// ==================== Grammar ====================
function renderGrammar() {
    const container = $('grammarList');
    const lessons = DATABASE.grammar[appState.currentLevel] || [];
    if (!lessons.length) { container.innerHTML = '<div class="empty-state"><i class="fas fa-book"></i><p>لا توجد دروس</p></div>'; return; }
    container.innerHTML = lessons.map(l =>
        `<div class="category-item" onclick="openGrammarLesson('${l.id}')"><div class="category-icon" style="background: linear-gradient(135deg, var(--b2-color), #F87171); color: white;"><i class="fas fa-${getCategoryIcon(l.icon, l.id)}"></i></div><div class="category-info"><div class="category-name">${l.title}</div><div class="category-meta">${l.subtitle || ''}</div></div><i class="fas fa-chevron-left category-arrow"></i></div>`
    ).join('');
}

function openGrammarLesson(id) {
    saveScrollPosition('grammarPage');
    const lesson = (DATABASE.grammar[appState.currentLevel] || []).find(l => l.id === id);
    if (!lesson?.content) return;
    
    // تعديل 5: تسجيل تعلم القواعد
    const grammarKey = `${appState.currentLevel}_${id}`;
    if (!appState.learnedGrammar[grammarKey]) {
        appState.learnedGrammar[grammarKey] = { learned: true, date: new Date().toISOString() };
        saveState();
    }
    
    $('grammarDetailTitle').textContent = lesson.title;
    let html = `<div class="grammar-section"><div class="grammar-section-title"><i class="fas fa-info-circle"></i> الشرح</div><p style="font-size: 14px; line-height: 1.8;">${lesson.content.explanation}</p></div>`;
    if (lesson.content.table?.length) {
        html += `<div class="grammar-section"><div class="grammar-section-title"><i class="fas fa-table"></i> التصريف</div><table class="grammar-table"><thead><tr><th>الضمير</th><th>التصريف</th><th>المعنى</th></tr></thead><tbody>${lesson.content.table.map(r => `<tr><td>${r.pronoun}</td><td class="italian-cell" style="font-weight: 700; color: var(--primary);">${r.conjugation}</td><td>${r.meaning}</td></tr>`).join('')}</tbody></table></div>`;
    }
    if (lesson.content.examples?.length) {
        html += `<div class="grammar-section"><div class="grammar-section-title"><i class="fas fa-lightbulb"></i> أمثلة</div>${lesson.content.examples.map(ex => `<div class="grammar-example"><div class="grammar-example-it">${ex.it}<button onclick="speak('${escapeQuotes(ex.it)}')" style="background: none; border: none; color: var(--primary); cursor: pointer; margin-right: 10px;"><i class="fas fa-volume-up"></i></button></div><div class="grammar-example-ar">${ex.ar}</div></div>`).join('')}</div>`;
    }
    $('grammarDetailContent').innerHTML = html;
    $$('.page').forEach(p => p.classList.remove('active'));
    $('grammarDetailPage').classList.add('active');
    addXP(5);
}

// ==================== Quiz ====================
function startQuiz(type) {
    quizType = type;
    const allWords = getCurrentLevelWords();
    if (allWords.length < 4) { showToast('لا توجد كلمات كافية', 'warning'); return; }

    let qs = allWords.map(w => {
        if (type === 'reverse') return { question: `ما الترجمة الإيطالية لـ "${w.ar}"؟`, correct: w.it, allAnswers: allWords.map(x => x.it), audio: w.it, isItalian: true };
        if (type === 'listening') return { question: 'استمع واختر الترجمة الصحيحة', correct: w.ar, allAnswers: allWords.map(x => x.ar), audio: w.it };
        return { question: `ما معنى "<span class="italian-word">${w.it}</span>"؟`, correct: w.ar, allAnswers: allWords.map(x => x.ar), audio: w.it };
    });

    qs = qs.sort(() => Math.random() - 0.5).slice(0, type === 'mixed' ? 15 : 10);
    qs.forEach(q => {
        const wrong = q.allAnswers.filter(a => a !== q.correct).sort(() => Math.random() - 0.5).slice(0, 3);
        q.options = [q.correct, ...wrong].sort(() => Math.random() - 0.5);
    });

    quizQuestions = qs; currentQuizIndex = 0; quizScore = 0;
    $('quizContainer').style.display = 'block'; $('quizResult').style.display = 'none';
    $('quizTotalQ').textContent = quizQuestions.length;
    $('quizListeningBtn').style.display = type === 'listening' ? 'block' : 'none';
    $$('.page').forEach(p => p.classList.remove('active'));
    $('quizPage').classList.add('active');
    displayQuizQuestion();
}

function displayQuizQuestion() {
    const q = quizQuestions[currentQuizIndex];
    $('quizCurrentQ').textContent = currentQuizIndex + 1;
    $('quizProgressBar').style.width = ((currentQuizIndex + 1) / quizQuestions.length * 100) + '%';
    $('quizQuestionText').innerHTML = q.question;
    $('quizQuestionHint').textContent = quizType === 'listening' ? 'اضغط للاستماع' : 'اختر الإجابة الصحيحة';

    const letters = ['أ', 'ب', 'ج', 'د'];
    $('quizOptions').innerHTML = q.options.map((opt, i) =>
        `<div class="quiz-option" onclick="selectQuizOption(this, '${escapeQuotes(opt)}')"><div class="quiz-option-letter">${letters[i]}</div><span class="quiz-option-text ${q.isItalian ? 'italian-text' : ''}">${opt}</span>${q.isItalian ? `<button class="quiz-option-speak" onclick="event.stopPropagation(); speak('${escapeQuotes(opt)}')"><i class="fas fa-volume-up"></i></button>` : ''}</div>`
    ).join('');

    $('quizNextBtn').style.display = 'none';
    if (quizType === 'listening' && q.audio) setTimeout(() => speak(q.audio), 500);
}

function playQuizAudio() { const q = quizQuestions[currentQuizIndex]; if (q?.audio) speak(q.audio); }

function selectQuizOption(el, selected) {
    const q = quizQuestions[currentQuizIndex];
    $$('.quiz-option').forEach(o => o.classList.add('disabled'));
    el.classList.add('selected');
    appState.totalQuizQuestions++;

    if (selected === q.correct) {
        el.classList.add('correct'); quizScore++; appState.totalCorrectAnswers++;
        showToast('✓ صحيح!', 'success');
    } else {
        el.classList.add('wrong');
        $$('.quiz-option').forEach(o => { if (o.querySelector('.quiz-option-text').textContent === q.correct) o.classList.add('correct'); });
        showToast('✗ خطأ!', 'error');
    }

    $('quizNextBtn').style.display = 'block';
    $('quizNextBtn').innerHTML = currentQuizIndex < quizQuestions.length - 1 ? 'التالي <i class="fas fa-chevron-left"></i>' : 'النتائج <i class="fas fa-trophy"></i>';
}

function nextQuizQuestion() { if (currentQuizIndex < quizQuestions.length - 1) { currentQuizIndex++; displayQuizQuestion(); } else showQuizResult(); }

function showQuizResult() {
    $('quizContainer').style.display = 'none'; $('quizResult').style.display = 'block';
    const percent = Math.round((quizScore / quizQuestions.length) * 100);
    const xpEarned = quizScore * 5;
    if (percent === 100) appState.perfectQuizzes++;

    let icon = '💪', title = 'حاول مجدداً!';
    if (percent >= 90) { icon = '🏆'; title = 'ممتاز!'; }
    else if (percent >= 70) { icon = '🎉'; title = 'جيد جداً!'; }
    else if (percent >= 50) { icon = '👍'; title = 'جيد!'; }

    $('quizResultIcon').textContent = icon;
    $('quizResultTitle').textContent = title;
    $('quizResultScore').textContent = `${quizScore}/${quizQuestions.length} (${percent}%)`;
    $('quizCorrectCount').textContent = quizScore;
    $('quizWrongCount').textContent = quizQuestions.length - quizScore;
    $('quizXPEarned').textContent = '+' + xpEarned;

    appState.quizzesDone++;
    addXP(xpEarned);
}

function restartQuiz() { startQuiz(quizType); }
function confirmExitQuiz() { if (confirm('الخروج من الاختبار؟')) goHome(); }

// ==================== Practice Exercises ====================
function startFlashcards() {
    const words = getCurrentLevelWords();
    if (!words.length) { showToast('لا توجد كلمات', 'warning'); return; }
    currentWords = words.sort(() => Math.random() - 0.5).slice(0, 20);
    currentWordIndex = 0; currentCategory = 'practice'; previousPage = 'practice';
    $('wordCategoryTitle').textContent = `بطاقات - ${appState.currentLevel.toUpperCase()}`;
    $$('.page').forEach(p => p.classList.remove('active'));
    $('wordStudyPage').classList.add('active');
    displayCurrentWord();
}

function startSpellingExercise() {
    exerciseWords = getCurrentLevelWords().sort(() => Math.random() - 0.5).slice(0, 10);
    if (exerciseWords.length < 3) { showToast('لا توجد كلمات كافية', 'warning'); return; }
    exerciseIndex = 0; exerciseScore = 0; exerciseType = 'spelling';
    $('exerciseTitle').textContent = 'تمرين الإملاء';
    $$('.page').forEach(p => p.classList.remove('active'));
    $('exercisePage').classList.add('active');
    displaySpellingExercise();
}

function displaySpellingExercise() {
    if (exerciseIndex >= exerciseWords.length) { showExerciseResult(); return; }
    const word = exerciseWords[exerciseIndex];
    $('exerciseProgress').textContent = `${exerciseIndex + 1}/${exerciseWords.length}`;
    $('exerciseContent').innerHTML = `<div class="exercise-card"><div class="exercise-title">اكتب الكلمة الإيطالية لـ:</div><div style="font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 20px; color: var(--primary);">${word.ar}</div><button class="listening-btn" onclick="speak('${escapeQuotes(word.it)}')"><i class="fas fa-volume-up"></i></button><div class="exercise-hint">💡 اضغط للاستماع</div><input type="text" class="exercise-input" id="spellingInput" placeholder="اكتب الكلمة..." autocomplete="off"><button class="word-control-btn primary" onclick="checkSpelling()" style="width: 100%;">تحقق</button></div>`;
    $('spellingInput')?.focus();
}

function checkSpelling() {
    const input = $('spellingInput');
    const word = exerciseWords[exerciseIndex];
    if (input.value.trim().toLowerCase() === word.it.toLowerCase()) {
        input.classList.add('correct'); exerciseScore++; addXP(5); showToast('✓ صحيح!', 'success');
    } else {
        input.classList.add('wrong'); showToast(`✗ الإجابة: ${word.it}`, 'error');
    }
    setTimeout(() => { exerciseIndex++; displaySpellingExercise(); }, 1500);
}

function startWordBuilder() {
    exerciseWords = getCurrentLevelWords().sort(() => Math.random() - 0.5).slice(0, 10);
    if (exerciseWords.length < 3) { showToast('لا توجد كلمات كافية', 'warning'); return; }
    exerciseIndex = 0; exerciseScore = 0; exerciseType = 'builder'; selectedLetters = [];
    $('exerciseTitle').textContent = 'تركيب الكلمات';
    $$('.page').forEach(p => p.classList.remove('active'));
    $('exercisePage').classList.add('active');
    displayWordBuilder();
}

function displayWordBuilder() {
    if (exerciseIndex >= exerciseWords.length) { showExerciseResult(); return; }
    const word = exerciseWords[exerciseIndex];
    const letters = word.it.split('').sort(() => Math.random() - 0.5);
    selectedLetters = [];
    $('exerciseProgress').textContent = `${exerciseIndex + 1}/${exerciseWords.length}`;
    $('exerciseContent').innerHTML = `<div class="exercise-card"><div class="exercise-title">رتب الحروف لتكوين الكلمة:</div><div style="font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 20px; color: var(--text-secondary);">${word.ar}</div><div class="answer-tiles" id="answerTiles"></div><div class="letter-tiles" id="letterTiles">${letters.map((l, i) => `<div class="letter-tile" data-index="${i}" onclick="selectLetter(this, '${l}')">${l}</div>`).join('')}</div><div style="display: flex; gap: 10px; margin-top: 15px;"><button class="word-control-btn secondary" onclick="clearAnswer()" style="flex: 1;"><i class="fas fa-undo"></i> مسح</button><button class="word-control-btn primary" onclick="checkWordBuilder()" style="flex: 1;">تحقق</button></div></div>`;
}

function selectLetter(el, letter) {
    if (el.classList.contains('disabled')) return;
    el.classList.add('disabled');
    selectedLetters.push({ letter, el });
    const tile = document.createElement('div');
    tile.className = 'letter-tile selected';
    tile.textContent = letter;
    tile.onclick = () => { tile.remove(); el.classList.remove('disabled'); selectedLetters = selectedLetters.filter(l => l.el !== el); };
    $('answerTiles').appendChild(tile);
}

function clearAnswer() {
    $('answerTiles').innerHTML = '';
    $$('.letter-tile').forEach(t => t.classList.remove('disabled'));
    selectedLetters = [];
}

function checkWordBuilder() {
    const word = exerciseWords[exerciseIndex];
    const answer = selectedLetters.map(l => l.letter).join('');
    if (answer.toLowerCase() === word.it.toLowerCase()) { exerciseScore++; addXP(5); showToast('✓ صحيح!', 'success'); }
    else showToast(`✗ الإجابة: ${word.it}`, 'error');
    selectedLetters = [];
    setTimeout(() => { exerciseIndex++; displayWordBuilder(); }, 1500);
}

function startMatchingGame() {
    const words = getCurrentLevelWords().sort(() => Math.random() - 0.5).slice(0, 6);
    if (words.length < 4) { showToast('لا توجد كلمات كافية', 'warning'); return; }
    matchingCards = [];
    words.forEach(w => {
        matchingCards.push({ text: w.it, pair: w.it, type: 'it', matched: false });
        matchingCards.push({ text: w.ar, pair: w.it, type: 'ar', matched: false });
    });
    matchingCards = matchingCards.sort(() => Math.random() - 0.5);
    firstSelectedCard = null; matchingLocked = false; matchedCount = 0; matchingMoves = 0;
    $('exerciseTitle').textContent = 'لعبة المطابقة';
    $('exerciseProgress').textContent = `0/${words.length}`;
    $$('.page').forEach(p => p.classList.remove('active'));
    $('exercisePage').classList.add('active');
    renderMatchingGame();
}

function renderMatchingGame() {
    $('exerciseContent').innerHTML = `<div class="exercise-card"><div class="exercise-title">طابق الكلمات الإيطالية بمعانيها</div><div class="matching-stats"><div class="matching-stat"><div class="matching-stat-value" id="matchingPairs">${matchedCount}/${matchingCards.length / 2}</div><div class="matching-stat-label">أزواج</div></div><div class="matching-stat"><div class="matching-stat-value" id="matchingMoves">${matchingMoves}</div><div class="matching-stat-label">محاولات</div></div></div><div class="matching-game">${matchingCards.map((c, i) => `<div class="matching-card ${c.type === 'it' ? 'italian-card' : ''} ${c.matched ? 'matched' : ''}" data-index="${i}" onclick="selectMatchingCard(${i})">${c.text}</div>`).join('')}</div></div>`;
}

function selectMatchingCard(index) {
    if (matchingLocked || matchingCards[index].matched) return;
    const cardEl = document.querySelector(`.matching-card[data-index="${index}"]`);
    if (!cardEl || cardEl.classList.contains('flipped')) return;
    cardEl.classList.add('flipped');

    if (!firstSelectedCard) {
        firstSelectedCard = { index, card: matchingCards[index], el: cardEl };
    } else {
        matchingMoves++;
        $('matchingMoves').textContent = matchingMoves;
        if (firstSelectedCard.index === index) return;

        if (firstSelectedCard.card.pair === matchingCards[index].pair && firstSelectedCard.card.type !== matchingCards[index].type) {
            matchingLocked = true;
            setTimeout(() => {
                firstSelectedCard.el.classList.remove('flipped'); firstSelectedCard.el.classList.add('matched');
                cardEl.classList.remove('flipped'); cardEl.classList.add('matched');
                matchingCards[firstSelectedCard.index].matched = true;
                matchingCards[index].matched = true;
                matchedCount++;
                $('matchingPairs').textContent = `${matchedCount}/${matchingCards.length / 2}`;
                $('exerciseProgress').textContent = `${matchedCount}/${matchingCards.length / 2}`;
                addXP(5); showToast('✓ تطابق!', 'success');
                firstSelectedCard = null; matchingLocked = false;
                if (matchedCount === matchingCards.length / 2) {
                    setTimeout(() => {
                        addXP(Math.max(0, 30 - matchingMoves) * 2);
                        showToast(`🎉 أكملت في ${matchingMoves} محاولة`, 'success');
                        setTimeout(() => openSection('practice'), 1500);
                    }, 500);
                }
            }, 300);
        } else {
            matchingLocked = true;
            firstSelectedCard.el.classList.add('wrong'); cardEl.classList.add('wrong');
            setTimeout(() => {
                firstSelectedCard.el.classList.remove('flipped', 'wrong');
                cardEl.classList.remove('flipped', 'wrong');
                firstSelectedCard = null; matchingLocked = false;
            }, 800);
        }
    }
}

function startListeningExercise() {
    exerciseWords = getCurrentLevelWords().sort(() => Math.random() - 0.5).slice(0, 10);
    if (exerciseWords.length < 3) { showToast('لا توجد كلمات كافية', 'warning'); return; }
    exerciseIndex = 0; exerciseScore = 0; exerciseType = 'listening';
    $('exerciseTitle').textContent = 'تمرين الاستماع';
    $$('.page').forEach(p => p.classList.remove('active'));
    $('exercisePage').classList.add('active');
    displayListeningExercise();
}

function displayListeningExercise() {
    if (exerciseIndex >= exerciseWords.length) { showExerciseResult(); return; }
    const word = exerciseWords[exerciseIndex];
    $('exerciseProgress').textContent = `${exerciseIndex + 1}/${exerciseWords.length}`;
    $('exerciseContent').innerHTML = `<div class="exercise-card"><div class="exercise-title">استمع واكتب ما تسمعه</div><button class="listening-btn" onclick="speak('${escapeQuotes(word.it)}')"><i class="fas fa-volume-up"></i></button><div class="exercise-hint">اضغط للاستماع</div><input type="text" class="exercise-input" id="listeningInput" placeholder="اكتب ما سمعته..." autocomplete="off"><button class="word-control-btn primary" onclick="checkListening()" style="width: 100%;">تحقق</button></div>`;
    setTimeout(() => speak(word.it), 500);
}

function checkListening() {
    const input = $('listeningInput');
    const word = exerciseWords[exerciseIndex];
    if (input.value.trim().toLowerCase() === word.it.toLowerCase()) {
        input.classList.add('correct'); exerciseScore++; addXP(5); showToast('✓ صحيح!', 'success');
    } else {
        input.classList.add('wrong'); showToast(`✗ الإجابة: ${word.it} (${word.ar})`, 'error');
    }
    setTimeout(() => { exerciseIndex++; displayListeningExercise(); }, 1500);
}

function showExerciseResult() {
    const percent = Math.round((exerciseScore / exerciseWords.length) * 100);
    $('exerciseContent').innerHTML = `<div class="exercise-card" style="text-align: center;"><div style="font-size: 50px; margin-bottom: 15px;">${percent >= 70 ? '🎉' : '💪'}</div><div style="font-size: 22px; font-weight: 800; margin-bottom: 10px;">${percent >= 70 ? 'ممتاز!' : 'أحسنت!'}</div><div style="font-size: 18px; margin-bottom: 20px;">${exerciseScore}/${exerciseWords.length} (${percent}%)</div><button class="word-control-btn primary" onclick="openSection('practice')" style="width: 100%;"><i class="fas fa-arrow-right"></i> العودة</button></div>`;
}

function exitExercise() { openSection('practice'); }

// ==================== Achievements ====================
function checkAchievements() {
    let total = 0;
    Object.values(appState.learnedWords).forEach(c => total += Object.keys(c).length);
    const stats = { totalWordsLearned: total, quizzesDone: appState.quizzesDone, perfectQuizzes: appState.perfectQuizzes, streak: appState.streak, xp: appState.xp, likedWords: appState.likedWords };
    ACHIEVEMENTS.forEach(ach => {
        if (!appState.unlockedAchievements.includes(ach.id) && ach.condition(stats)) {
            appState.unlockedAchievements.push(ach.id);
            appState.newAchievements.push(ach.id);
            appState.xp += ach.xp;
            addNotification('achievement', `إنجاز: ${ach.title}`, ach.desc, Date.now());
            showAchievementModal(ach);
            saveState();
        }
    });
    updateAchievementsUI();
}

function showAchievementModal(ach) {
    $('achievementUnlockedIcon').textContent = ach.icon;
    $('achievementUnlockedTitle').textContent = ach.title;
    $('achievementUnlockedDesc').textContent = ach.desc;
    $('achievementUnlockedXP').textContent = '+' + ach.xp + ' XP';
    $('modalOverlay').classList.add('show');
    $('achievementModal').classList.add('show');
}

function closeAchievementModal() { $('modalOverlay').classList.remove('show'); $('achievementModal').classList.remove('show'); }

function updateAchievementsUI() {
    const badge = $('achievementsBadge');
    if (badge) badge.style.display = appState.newAchievements.length > 0 ? 'flex' : 'none';
}

function renderAchievements() {
    let total = 0;
    Object.values(appState.learnedWords).forEach(c => total += Object.keys(c).length);
    const stats = { totalWordsLearned: total, quizzesDone: appState.quizzesDone, perfectQuizzes: appState.perfectQuizzes, streak: appState.streak, xp: appState.xp, likedWords: appState.likedWords };
    const targets = { first_word: 1, ten_words: 10, fifty_words: 50, hundred_words: 100, first_quiz: 1, five_quizzes: 5, perfect_quiz: 1, streak_3: 3, streak_7: 7, xp_100: 100, xp_500: 500, liked_10: 10 };
    const values = { first_word: total, ten_words: total, fifty_words: total, hundred_words: total, first_quiz: appState.quizzesDone, five_quizzes: appState.quizzesDone, perfect_quiz: appState.perfectQuizzes, streak_3: appState.streak, streak_7: appState.streak, xp_100: appState.xp, xp_500: appState.xp, liked_10: appState.likedWords.length };

    $('achievementsGrid').innerHTML = ACHIEVEMENTS.map(ach => {
        const unlocked = appState.unlockedAchievements.includes(ach.id);
        const progress = Math.min((values[ach.id] / targets[ach.id]) * 100, 100) || 0;
        return `<div class="achievement-card ${unlocked ? 'unlocked' : 'locked'}">${unlocked ? '<div class="achievement-badge">✓</div>' : ''}<div class="achievement-xp">+${ach.xp} XP</div><div class="achievement-icon">${ach.icon}</div><div class="achievement-title">${ach.title}</div><div class="achievement-desc">${ach.desc}</div>${!unlocked ? `<div class="achievement-progress"><div class="achievement-progress-fill" style="width: ${progress}%"></div></div>` : ''}</div>`;
    }).join('');
    appState.newAchievements = [];
    saveState();
    updateAchievementsUI();
    $('unlockedAchievements').textContent = appState.unlockedAchievements.length;
}

// ==================== Statistics ====================
function renderStatistics() {
    let total = 0;
    Object.values(appState.learnedWords).forEach(c => total += Object.keys(c).length);
    $('statTotalWords').textContent = total;
    $('statTotalXP').textContent = appState.xp;
    $('statTotalQuizzes').textContent = appState.quizzesDone;
    $('statAccuracy').textContent = (appState.totalQuizQuestions > 0 ? Math.round((appState.totalCorrectAnswers / appState.totalQuizQuestions) * 100) : 0) + '%';
    $('statCurrentStreak').textContent = appState.streak;
    $('statLongestStreak').textContent = appState.longestStreak;
    $('statTotalDays').textContent = appState.totalDaysLearned;
    $('statAvgTime').textContent = calculateAvgTime();

    ['a1', 'a2', 'b1', 'b2'].forEach(l => {
        const p = calculateLevelProgress(l);
        const el = $(`stat${l.toUpperCase()}Progress`);
        const val = $(`stat${l.toUpperCase()}Value`);
        if (el) el.style.width = p + '%';
        if (val) val.textContent = p + '%';
    });
    renderWeeklyChart();
}

function calculateAvgTime() {
    if (appState.studySessions?.length) {
        const total = appState.studySessions.reduce((a, s) => a + (s.duration || 0), 0);
        const avg = Math.round(total / appState.studySessions.length / 60000);
        if (avg > 0) return avg < 60 ? `${avg} د` : `${Math.floor(avg / 60)} س`;
    }
    const days = appState.totalDaysLearned || 1;
    const est = Math.round((appState.xp / 10) / days);
    return est > 0 ? (est < 60 ? `${est} د` : `${Math.floor(est / 60)} س`) : '0 د';
}

function renderWeeklyChart() {
    const chart = $('weeklyChart'); if (!chart) return;
    const days = ['س', 'أ', 'إ', 'ث', 'أ', 'خ', 'ج'];
    const max = Math.max(...appState.weeklyXP, 50);
    chart.innerHTML = appState.weeklyXP.map((xp, i) =>
        `<div class="chart-bar" style="height: 100%;"><div class="chart-bar-fill" style="height: ${max > 0 ? (xp / max) * 100 : 0}%"></div><div class="chart-bar-label">${days[i]}</div></div>`
    ).join('');
}

// ==================== Streak & XP ====================
function checkStreak() {
    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (appState.lastStudyDate !== today) appState.dailyXP = 0;
    if (appState.lastStudyDate && appState.lastStudyDate !== today && appState.lastStudyDate !== yesterday) appState.streak = 0;
}

function recordStudy() {
    const today = new Date().toDateString();
    const dow = new Date().getDay();
    if (appState.lastStudyDate !== today) {
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        appState.streak = (appState.lastStudyDate === yesterday || !appState.lastStudyDate) ? appState.streak + 1 : 1;
        if (appState.streak > appState.longestStreak) appState.longestStreak = appState.streak;
        if ([3, 7, 30].includes(appState.streak)) addNotification('streak', `${appState.streak} أيام! 🔥`, 'استمر', Date.now());
        appState.lastStudyDate = today;
        appState.totalDaysLearned++;
    }
    appState.weeklyXP[dow] = (appState.weeklyXP[dow] || 0) + 1;
    saveState();
    updateUI();
}

function addXP(amount) {
    appState.xp += amount;
    appState.dailyXP += amount;
    appState.weeklyXP[new Date().getDay()] = (appState.weeklyXP[new Date().getDay()] || 0) + amount;

    if (appState.dailyXP >= appState.dailyGoal && appState.dailyXP - amount < appState.dailyGoal) {
        appState.lastGoalCompleted = new Date().toDateString();
        addNotification('xp', 'أكملت هدفك! 🎯', `${appState.dailyGoal} XP`, Date.now());
        showToast('🎯 أكملت هدفك اليومي!', 'success');
    }

    const newLevel = Math.floor(appState.xp / 100) + 1;
    if (newLevel > appState.userLevel) {
        appState.userLevel = newLevel;
        addNotification('level', `مستوى ${newLevel}! 🎉`, 'أحسنت', Date.now());
        showToast(`🎉 وصلت للمستوى ${newLevel}!`, 'success');
    }

    recordStudy();
    checkAchievements();
    saveState();
    updateUI();
    updateDailyGoalUI();
}

// ==================== تعديل 5: حساب العبارات والقواعد المتعلمة ====================
function getLearnedPhrasesCount() {
    let count = 0;
    Object.keys(appState.learnedPhrases).forEach(key => {
        if (key.startsWith(appState.currentLevel + '_')) count++;
    });
    return count;
}

function getLearnedGrammarCount() {
    let count = 0;
    Object.keys(appState.learnedGrammar).forEach(key => {
        if (key.startsWith(appState.currentLevel + '_')) count++;
    });
    return count;
}

// ==================== Profile ====================
function updateProfile() {
    $('profileLevel').textContent = appState.userLevel;
    $('profileXP').textContent = appState.xp;
    const xpCurrent = appState.xp % 100;
    $('profileProgressFill').style.width = xpCurrent + '%';
    $('profileXPNext').textContent = 100 - xpCurrent;

    let total = 0;
    Object.values(appState.learnedWords).forEach(c => total += Object.keys(c).length);
    $('totalWords').textContent = total;
    $('totalQuizzes').textContent = appState.quizzesDone;
    $('currentStreak').textContent = appState.streak;
    $('longestStreak').textContent = appState.longestStreak;

    $('likedCount').textContent = appState.likedWords.length + ' كلمات';
    const preview = $('likedWordsPreview');
    if (!appState.likedWords.length) {
        preview.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 12px;">لا توجد كلمات مفضلة</div>';
    } else {
        preview.innerHTML = appState.likedWords.slice(0, 3).map(w => `<div style="display: inline-block; background: var(--light); padding: 5px 10px; border-radius: 15px; margin: 3px; font-size: 12px;">❤️ <span class="italian-text">${w.it}</span></div>`).join('') + (appState.likedWords.length > 3 ? `<div style="display: inline-block; color: var(--text-secondary); font-size: 11px; margin: 3px;">+${appState.likedWords.length - 3}</div>` : '');
    }
}

function confirmDeleteLikedWord(index) {
    pendingDeleteWord = index; pendingAction = 'deleteLikedWord';
    const word = appState.likedWords[index];
    $('confirmIcon').textContent = '🗑️';
    $('confirmTitle').textContent = 'حذف الكلمة؟';
    $('confirmText').textContent = `هل تريد حذف "${word.it}"؟`;
    $('confirmBtn').textContent = 'حذف';
    $('modalOverlay').classList.add('show');
    $('confirmDialog').classList.add('show');
}

function confirmAction() {
    if (pendingAction === 'deleteLikedWord' && pendingDeleteWord !== null) {
        appState.likedWords.splice(pendingDeleteWord, 1);
        saveState();
        renderFavorites();
        updateWodLikeBtn();
        showToast('تم الحذف', 'success');
    }
    closeConfirmDialog();
}

function closeConfirmDialog() {
    $('modalOverlay').classList.remove('show');
    $('confirmDialog').classList.remove('show');
    pendingDeleteWord = null; pendingAction = null;
}

// ==================== UI Update ====================
const updateUI = throttle(() => {
    const set = (id, val) => { const el = $(id); if (el) el.textContent = val; };
    set('streakCount', appState.streak);
    set('xpCount', appState.xp);
    set('userLevel', appState.userLevel);
    set('dailyXP', appState.dailyXP);
    set('dailyTarget', appState.dailyGoal);

    const fill = $('dailyGoalFill');
    if (fill) fill.style.width = Math.min((appState.dailyXP / appState.dailyGoal) * 100, 100) + '%';

    set('currentLevelDisplay', appState.currentLevel.toUpperCase());
    $$('.current-level-text').forEach(el => el.textContent = appState.currentLevel.toUpperCase());

    const progress = calculateLevelProgress(appState.currentLevel);
    set('levelProgress', progress + '%');
    const bar = $('levelProgressBar');
    if (bar) { bar.style.width = progress + '%'; bar.className = `progress-bar-fill ${appState.currentLevel}`; }

    let wordsCount = 0;
    Object.keys(appState.learnedWords).forEach(k => { if (k.startsWith(appState.currentLevel + '_')) wordsCount += Object.keys(appState.learnedWords[k]).length; });
    set('wordsLearned', wordsCount);
    
    // تعديل 5: تحديث عداد العبارات والقواعد
    set('phrasesLearned', getLearnedPhrasesCount());
    set('grammarLearned', getLearnedGrammarCount());
    set('quizzesDone', appState.quizzesDone);

    updateCounts();
    updateAchievementsUI();
    updateNotificationsBadge();
    updateLevelProgressIndicators();
    updateDailyGoalUI();
}, 100);

function updateCounts() {
    const level = appState.currentLevel;
    let totalWords = 0;
    Object.values(DATABASE.words[level] || {}).forEach(c => totalWords += c.words?.length || 0);
    const set = (id, val) => { const el = $(id); if (el) el.textContent = val; };
    set('wordsCount', totalWords + ' كلمة');

    let totalPhrases = 0;
    (DATABASE.phrases[level] || []).forEach(p => totalPhrases += p.phrases?.length || 0);
    set('phrasesCount', totalPhrases + ' عبارة');
    set('conversationsCount', (DATABASE.conversations[level]?.length || 0) + ' محادثة');
    set('grammarCount', (DATABASE.grammar[level]?.length || 0) + ' درس');
}

// ==================== Notifications ====================
function initNotifications() {
    if (!appState.notifications.length) addNotification('reminder', 'مرحباً بك! 📚', 'ابدأ التعلم', Date.now());
    updateNotificationsBadge();
}

function addNotification(type, text, desc, time) {
    appState.notifications.unshift({ id: Date.now(), type, text, desc, time, read: false });
    if (appState.notifications.length > 20) appState.notifications = appState.notifications.slice(0, 20);
    saveState();
    updateNotificationsBadge();
}

function toggleNotificationsPanel() {
    const d = $('notificationsDropdown');
    d.classList.toggle('show');
    if (d.classList.contains('show')) renderNotifications();
}

function closeNotifications(e) { if (e.target.id === 'notificationsDropdown') $('notificationsDropdown').classList.remove('show'); }

function renderNotifications() {
    const list = $('notificationsList');
    if (!appState.notifications.length) {
        list.innerHTML = '<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>لا توجد إشعارات</p></div>';
        return;
    }
    const icons = { achievement: '🏆', streak: '🔥', xp: '⭐', reminder: '⏰', level: '🎉' };
    list.innerHTML = appState.notifications.map(n => {
        const ago = Math.floor((Date.now() - n.time) / 1000);
        const timeText = ago < 60 ? 'الآن' : ago < 3600 ? `منذ ${Math.floor(ago / 60)} د` : ago < 86400 ? `منذ ${Math.floor(ago / 3600)} س` : `منذ ${Math.floor(ago / 86400)} يوم`;
        return `<div class="notification-item ${n.read ? '' : 'unread'}" onclick="markNotificationRead(${n.id})"><div class="notification-icon ${n.type}">${icons[n.type] || '📢'}</div><div class="notification-content"><div class="notification-text">${n.text}</div><div class="notification-desc">${n.desc}</div><div class="notification-time">${timeText}</div></div></div>`;
    }).join('');
}

function markNotificationRead(id) {
    const n = appState.notifications.find(x => x.id === id);
    if (n) { n.read = true; saveState(); updateNotificationsBadge(); renderNotifications(); }
}

function clearAllNotifications() {
    appState.notifications = [];
    saveState();
    updateNotificationsBadge();
    renderNotifications();
    showToast('تم مسح الإشعارات', 'success');
}

function updateNotificationsBadge() {
    const badge = $('notificationsBadge');
    const count = appState.notifications.filter(n => !n.read).length;
    if (badge) { badge.textContent = count > 9 ? '9+' : count; badge.style.display = count > 0 ? 'flex' : 'none'; }
}

// ==================== Settings ====================
function openSettings() {
    $('modalOverlay').classList.add('show');
    $('settingsModal').classList.add('show');
    $('darkModeToggle').classList.toggle('active', appState.darkMode);
    $('soundToggle').classList.toggle('active', appState.soundEnabled);
    renderSocialLinks();
}

function closeModal() { $('modalOverlay').classList.remove('show'); $('settingsModal').classList.remove('show'); }

function toggleDarkMode() {
    appState.darkMode = !appState.darkMode;
    document.body.classList.toggle('dark-mode', appState.darkMode);
    $('darkModeToggle').classList.toggle('active', appState.darkMode);
    saveState();
}

function toggleSound() {
    appState.soundEnabled = !appState.soundEnabled;
    $('soundToggle').classList.toggle('active', appState.soundEnabled);
    saveState();
    showToast(appState.soundEnabled ? '🔊 الصوت مفعّل' : '🔇 الصوت متوقف', 'info');
}

function resetProgress() {
    if (confirm('⚠️ هل أنت متأكد؟ سيتم حذف جميع بياناتك!')) {
        localStorage.removeItem(CONFIG.STATE_KEY);
        location.reload();
    }
}

function renderSocialLinks() {
    const container = $('socialLinks'); if (!container) return;
    let html = '';
    if (APP_CONFIG.social?.facebook) html += `<a href="${APP_CONFIG.social.facebook}" target="_blank" class="social-link facebook"><i class="fab fa-facebook-f"></i></a>`;
    if (APP_CONFIG.social?.instagram) html += `<a href="${APP_CONFIG.social.instagram}" target="_blank" class="social-link instagram"><i class="fab fa-instagram"></i></a>`;
    if (APP_CONFIG.social?.tiktok) html += `<a href="${APP_CONFIG.social.tiktok}" target="_blank" class="social-link tiktok"><i class="fab fa-tiktok"></i></a>`;
    container.innerHTML = html || '<p style="color: var(--text-secondary); font-size: 12px;">لا توجد روابط</p>';
}

function openInfoPage(type) {
    closeModal();
    const data = APP_CONFIG[type]; if (!data) return;
    $('infoPageTitle').textContent = data.title || type;
    const icons = { about: 'info-circle', contact: 'envelope', privacy: 'shield-alt', terms: 'file-contract' };
    let html = `<div class="info-page-icon"><i class="fas fa-${icons[type] || 'info'}"></i></div><div class="info-page-title">${data.title || ''}</div><div class="info-page-text">${data.content || ''}</div>`;
    if (type === 'contact' && data.email) html += `<div class="contact-item" style="margin-top: 20px;"><div class="contact-item-icon"><i class="fas fa-envelope"></i></div><div class="contact-item-text"><div class="contact-item-label">البريد</div><div class="contact-item-value">${data.email}</div></div></div>`;
    $('infoPageContent').innerHTML = html;
    $$('.page').forEach(p => p.classList.remove('active'));
    $('infoPage').classList.add('active');
}

function closeInfoPage() { goHome(); }

// ==================== Utilities ====================
function speak(text, rate = 0.8) {
    if (appState.soundEnabled && 'speechSynthesis' in window) {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'it-IT'; u.rate = rate;
        speechSynthesis.speak(u);
    }
}

function showToast(message, type = 'info') {
    const toast = $('toast'), msg = $('toastMessage'); if (!toast || !msg) return;
    clearTimeout(toastTimeout);
    msg.textContent = message;
    toast.className = `toast ${type}`;
    const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
    toast.querySelector('i').className = `fas ${icons[type] || icons.info}`;
    toast.classList.add('show');
    toastTimeout = setTimeout(() => toast.classList.remove('show'), 2500);
}

// ==================== Event Listeners ====================
$('modalOverlay')?.addEventListener('click', function(e) {
    if (e.target === this) { closeModal(); closeConfirmDialog(); closeAchievementModal(); }
});

document.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        const spell = $('spellingInput'), listen = $('listeningInput');
        if (spell && document.activeElement === spell) checkSpelling();
        else if (listen && document.activeElement === listen) checkListening();
    }
});

function updateOnlineStatus() {
    const banner = $('offlineBanner');
    if (banner) banner.classList.toggle('show', !navigator.onLine);
}

window.addEventListener('online', () => { updateOnlineStatus(); showToast('🌐 تم الاتصال', 'success'); });
window.addEventListener('offline', () => { updateOnlineStatus(); showToast('📴 غير متصل', 'warning'); });

window.addEventListener('beforeunload', () => {
    if (appState.sessionStartTime) {
        const duration = Date.now() - appState.sessionStartTime;
        if (duration > 60000) {
            if (!appState.studySessions) appState.studySessions = [];
            appState.studySessions.push({ date: new Date().toISOString(), duration });
            if (appState.studySessions.length > 30) appState.studySessions = appState.studySessions.slice(-30);
            saveState();
        }
    }
});

// ==================== Start App ====================
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initApp);
else initApp();
</script>
</body>
</html>